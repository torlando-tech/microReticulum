---
phase: 06-p1-stability-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Utilities/Persistence.h
  - src/Utilities/Persistence.cpp
  - src/ResourceData.h
autonomous: true

must_haves:
  truths:
    - "Firmware compiles cleanly with no ODR violations or linker warnings"
    - "Large file transfers complete without heap fragmentation from vector reallocations"
  artifacts:
    - path: "src/Utilities/Persistence.h"
      provides: "extern declarations for _document and _buffer"
      contains: "extern JsonDocument _document"
    - path: "src/Utilities/Persistence.cpp"
      provides: "Single definition of _document and _buffer"
      contains: "JsonDocument _document"
    - path: "src/ResourceData.h"
      provides: "MAX_PARTS constant and vector pre-allocation"
      contains: "static constexpr size_t MAX_PARTS"
  key_links:
    - from: "src/Utilities/Persistence.h"
      to: "src/Utilities/Persistence.cpp"
      via: "extern declaration + definition"
      pattern: "extern.*_document"
---

<objective>
Fix critical memory issues: ODR violation in Persistence module and unbounded vector growth in ResourceData.

Purpose: Eliminate linker issues and prevent heap fragmentation during large file transfers - two P1 stability issues with WSJF scores of 4.0 and 3.5.

Output: Clean-compiling code with pre-allocated vectors that don't resize during resource transfers.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-p1-stability-fixes/06-RESEARCH.md
@src/Utilities/Persistence.h
@src/Utilities/Persistence.cpp
@src/ResourceData.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ODR violation in Persistence module</name>
  <files>src/Utilities/Persistence.h, src/Utilities/Persistence.cpp</files>
  <action>
Fix the duplicate static definition causing ODR violation:

1. In `src/Utilities/Persistence.h` (around line 475):
   - Remove the `static` keyword and `DynamicJsonDocument` initialization
   - Change to extern declarations using ArduinoJson 7 API:
   ```cpp
   namespace RNS { namespace Persistence {
       extern JsonDocument _document;
       extern Bytes _buffer;
   }}
   ```

2. In `src/Utilities/Persistence.cpp` (around line 7):
   - Remove the commented `/*static*/` prefix
   - Change to proper namespace-scoped definitions:
   ```cpp
   namespace RNS { namespace Persistence {
       JsonDocument _document;  // v7 uses elastic allocation
       Bytes _buffer(Type::Persistence::BUFFER_MAXSIZE);
   }}
   ```

Note: `JsonDocument` in ArduinoJson 7 replaces `DynamicJsonDocument` with elastic allocation - no size parameter needed.
  </action>
  <verify>
- Compile the project: `pio run -e tdeck_plus` from project root
- Verify no linker warnings about duplicate symbols
- Verify no deprecation warnings about DynamicJsonDocument
  </verify>
  <done>
Single definition exists in cpp file, extern declaration in header, no ODR violation warnings during compilation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Pre-allocate ResourceData vectors</name>
  <files>src/ResourceData.h</files>
  <action>
Add MAX_PARTS constant and modify constructor to pre-allocate vectors:

1. Add constant near top of ResourceData class (after line 18):
   ```cpp
   public:
       // Maximum parts = MAX_EFFICIENT_SIZE / minimum SDU
       // MAX_EFFICIENT_SIZE = 16384, minimum SDU ~64 = ~256 parts max
       static constexpr size_t MAX_PARTS = 256;
   ```

2. Modify constructor (line 20) to reserve vector capacity:
   ```cpp
   ResourceData(const Link& link) : _link(link) {
       _parts.reserve(MAX_PARTS);
       _hashmap.reserve(MAX_PARTS);
   }
   ```

This prevents vector reallocations during resource transfers while keeping memory usage reasonable (256 * ~4 bytes per entry for hashmap, parts are populated on demand).
  </action>
  <verify>
- Compile the project: `pio run -e tdeck_plus` from project root
- Verify no compilation errors
- Grep for MAX_PARTS to confirm it's defined: `grep -r "MAX_PARTS" src/`
  </verify>
  <done>
MAX_PARTS constant defined at 256, constructor reserves capacity for both _parts and _hashmap vectors.
  </done>
</task>

</tasks>

<verification>
1. Full build succeeds: `pio run -e tdeck_plus`
2. No linker warnings about duplicate symbols in build output
3. No deprecation warnings about DynamicJsonDocument
4. ResourceData has MAX_PARTS constant and vector pre-allocation in constructor
</verification>

<success_criteria>
- MEM-01: Persistence compiles without ODR violation (single definition pattern)
- MEM-02: ResourceData vectors pre-allocated to MAX_PARTS (256) at construction
- Build completes cleanly with no warnings related to these changes
</success_criteria>

<output>
After completion, create `.planning/phases/06-p1-stability-fixes/06-01-SUMMARY.md`
</output>
