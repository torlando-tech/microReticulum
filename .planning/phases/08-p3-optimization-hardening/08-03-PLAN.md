---
phase: 08-p3-optimization-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/BLE/platforms/NimBLEPlatform.cpp
  - src/BLE/platforms/NimBLEPlatform.h
  - src/Hardware/TDeck/Display.cpp
  - src/Hardware/TDeck/Trackball.h
  - docs/CONCURRENCY.md
autonomous: true

must_haves:
  truths:
    - "All volatile variables have rationale comments explaining ISR-callback context"
    - "All delay() calls have rationale comments explaining timing requirements"
    - "CONCURRENCY.md has timing/volatile reference table"
  artifacts:
    - path: "src/BLE/platforms/NimBLEPlatform.h"
      provides: "Volatile usage documentation"
      pattern: "// VOLATILE RATIONALE:"
    - path: "src/BLE/platforms/NimBLEPlatform.cpp"
      provides: "Delay rationale documentation"
      pattern: "// DELAY RATIONALE:"
    - path: "docs/CONCURRENCY.md"
      provides: "Timing and volatile reference table"
      contains: "## Timing and Volatile Reference"
  key_links: []
---

<objective>
Document all undocumented delay() and volatile usage with rationale comments.

Purpose: Complete CONC-L1 (volatile documentation) and CONC-L2 (delay documentation) by adding inline rationale comments to code and a comprehensive reference table in CONCURRENCY.md.

Output: All timing-sensitive code sites have clear rationale. Developers can understand why specific values were chosen.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-p3-optimization-hardening/08-RESEARCH.md

# Files with volatile/delay to document
@src/BLE/platforms/NimBLEPlatform.h (volatile at lines 288-296)
@src/BLE/platforms/NimBLEPlatform.cpp (multiple delay sites)
@src/Hardware/TDeck/Display.cpp (delay for LCD timing)
@src/Hardware/TDeck/Trackball.h (volatile for ISR counters)
@docs/CONCURRENCY.md (target for reference table)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document volatile usage in NimBLEPlatform.h</name>
  <files>src/BLE/platforms/NimBLEPlatform.h</files>
  <action>
    Add documentation block before the volatile declarations (around line 288):

    ```cpp
    // VOLATILE RATIONALE: Native GAP handler callback flags
    //
    // These volatile flags synchronize between:
    // 1. NimBLE host task (callback context - runs asynchronously like ISR)
    // 2. BLE task (loop() context - application thread)
    //
    // Volatile is appropriate because:
    // - Single-word reads/writes are atomic on ESP32 (32-bit aligned)
    // - These are simple status flags, not complex state
    // - Mutex would cause priority inversion in callback context
    // - Memory barriers not needed - flag semantics sufficient
    //
    // Alternative rejected: Mutex acquisition in NimBLE callbacks can cause
    // priority inversion or deadlock since callbacks run in host task context.
    //
    // Reference: ESP32 Technical Reference Manual, Section 5.4 (Memory Consistency)
    volatile bool _async_connect_pending = false;
    volatile bool _async_connect_failed = false;
    volatile int _async_connect_error = 0;
    // ...
    ```

    Also add brief inline comments for the _native_connect_* group if separate.
  </action>
  <verify>
    Grep for "VOLATILE RATIONALE" in src/BLE/platforms/NimBLEPlatform.h - should exist.
  </verify>
  <done>
    All volatile declarations have rationale explaining callback/ISR context.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document volatile usage in Trackball.h</name>
  <files>src/Hardware/TDeck/Trackball.h</files>
  <action>
    Add documentation before the volatile static declarations (around line 93):

    ```cpp
    // VOLATILE RATIONALE: ISR pulse counters
    //
    // These are modified by hardware interrupt handlers (IRAM_ATTR ISRs)
    // and read by the main task for trackball input processing.
    //
    // Volatile required because:
    // - ISR context modifies values asynchronously
    // - Without volatile, compiler may cache values in registers
    // - 16-bit/32-bit aligned values are atomic on ESP32
    //
    // Reference: ESP-IDF GPIO interrupt documentation
    static volatile int16_t _pulse_up;
    static volatile int16_t _pulse_down;
    // ...
    ```
  </action>
  <verify>
    Grep for "VOLATILE RATIONALE" in src/Hardware/TDeck/Trackball.h - should exist.
  </verify>
  <done>
    Trackball ISR counter volatiles have rationale documented.
  </done>
</task>

<task type="auto">
  <name>Task 3: Document delay() sites in NimBLEPlatform.cpp</name>
  <files>src/BLE/platforms/NimBLEPlatform.cpp</files>
  <action>
    Add rationale comments to each delay() call. Use brief single-line comments for simple cases, multi-line blocks for complex ones.

    Key sites (per RESEARCH.md):

    Line 257 (100ms): `// DELAY RATIONALE: Stack init settling - NimBLE requires time to initialize internal structures`

    Line 287 (100ms): `// DELAY RATIONALE: Advertising restart - allow stack to process state change before retry`

    Line 406 (10ms): `// DELAY RATIONALE: Scan stop polling - check completion every NimBLE scheduler tick (~10ms)`

    Line 439 (10ms): `// DELAY RATIONALE: Advertising stop polling - same as scan stop`

    Line 502 (50ms):
    ```cpp
    // DELAY RATIONALE: Error recovery before retry
    // After BLE operation failure, NimBLE stack needs processing time before retry.
    // Without delay: immediate retry fails, rapid retries can trigger assertions.
    // 50ms = 5 NimBLE scheduler ticks, empirically chosen balance of recovery vs latency.
    // Shorter (10ms) saw retry failures; longer (100ms) adds noticeable delay.
    delay(50);
    ```

    Line 514 (50ms): `// DELAY RATIONALE: Connect attempt recovery - same as error recovery`

    Line 591 (20ms): `// DELAY RATIONALE: MTU negotiation settling - allow peer to process before next operation`

    Line 674 (10ms): `// DELAY RATIONALE: Connection loop polling - scheduler tick interval`

    Line 772 (20ms): `// DELAY RATIONALE: Service discovery settling - allow stack to finalize discovery`

    Line 787 (10ms): `// DELAY RATIONALE: Service discovery polling - check completion per scheduler tick`

    Line 970 (10ms): `// DELAY RATIONALE: Notification send retry - respect scheduler tick for queue processing`

    Line 1050 (50ms): Already has comment "Brief delay for reset to process" - enhance if needed

    Line 1060 (10ms): `// DELAY RATIONALE: Reset wait polling - check reset completion`

    Line 1073 (10ms): Already has comment - leave as is

    Line 1316 (10ms): `// DELAY RATIONALE: Loop iteration throttle - prevent tight loop CPU consumption`
  </action>
  <verify>
    Grep for "DELAY RATIONALE" in src/BLE/platforms/NimBLEPlatform.cpp - count should be >= 10.
  </verify>
  <done>
    All delay() calls in NimBLEPlatform.cpp have rationale comments.
  </done>
</task>

<task type="auto">
  <name>Task 4: Document delay() sites in Display.cpp</name>
  <files>src/Hardware/TDeck/Display.cpp</files>
  <action>
    Add rationale comments to Display.cpp delay sites:

    Line 104 (150ms):
    ```cpp
    // DELAY RATIONALE: LCD reset pulse width
    // ST7789 datasheet specifies minimum 120ms reset low time for reliable initialization.
    // Using 150ms for margin. Shorter values cause display initialization failures.
    delay(150);
    ```

    Lines 108, 124, 128, 132 (10ms each):
    `// DELAY RATIONALE: SPI command settling - allow display controller to process command before next`
  </action>
  <verify>
    Grep for "DELAY RATIONALE" in src/Hardware/TDeck/Display.cpp - should have entries.
  </verify>
  <done>
    Display timing delays have rationale referencing ST7789 specs.
  </done>
</task>

<task type="auto">
  <name>Task 5: Add timing/volatile reference table to CONCURRENCY.md</name>
  <files>docs/CONCURRENCY.md</files>
  <action>
    Add a new section before "## References" at the end of the file:

    ```markdown
    ## Timing and Volatile Reference

    This table summarizes all timing-sensitive delays and volatile variables in the codebase.
    See individual code sites for detailed rationale comments.

    ### Delay Sites

    | File | Line | Value | Purpose |
    |------|------|-------|---------|
    | NimBLEPlatform.cpp | 257 | 100ms | Stack init settling time |
    | NimBLEPlatform.cpp | 287 | 100ms | Advertising restart after recovery |
    | NimBLEPlatform.cpp | 406 | 10ms | Scan stop polling interval |
    | NimBLEPlatform.cpp | 439 | 10ms | Advertising stop polling |
    | NimBLEPlatform.cpp | 502 | 50ms | Error recovery before retry |
    | NimBLEPlatform.cpp | 514 | 50ms | Connect attempt recovery |
    | NimBLEPlatform.cpp | 591 | 20ms | MTU negotiation settling |
    | NimBLEPlatform.cpp | 674 | 10ms | Connection loop polling |
    | NimBLEPlatform.cpp | 772 | 20ms | Service discovery settling |
    | NimBLEPlatform.cpp | 787 | 10ms | Service discovery polling |
    | NimBLEPlatform.cpp | 970 | 10ms | Notification send retry interval |
    | NimBLEPlatform.cpp | 1050 | 50ms | Soft reset processing |
    | NimBLEPlatform.cpp | 1060 | 10ms | Reset wait polling |
    | NimBLEPlatform.cpp | 1073 | 10ms | Stack stabilization after reset |
    | NimBLEPlatform.cpp | 1316 | 10ms | Loop iteration throttle |
    | Display.cpp | 104 | 150ms | LCD reset pulse width (ST7789 spec) |
    | Display.cpp | 108,124,128,132 | 10ms | SPI command settling |

    ### Volatile Variables

    | File | Lines | Type | Purpose |
    |------|-------|------|---------|
    | NimBLEPlatform.h | 288-296 | bool/int/uint16 | Async connect callback flags |
    | Trackball.h | 93-97 | int16/uint32 | ISR pulse counters |

    **Timing design principles:**
    - 10ms: NimBLE scheduler tick interval (minimum useful polling)
    - 50ms: Error recovery (5 scheduler ticks for stack processing)
    - 100ms: State transition settling (advertising, initialization)
    - 150ms+: Hardware specs (display reset, etc.)
    ```
  </action>
  <verify>
    Check that docs/CONCURRENCY.md contains "## Timing and Volatile Reference" section.
  </verify>
  <done>
    CONCURRENCY.md has comprehensive timing/volatile reference table.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "VOLATILE RATIONALE" src/` returns matches in NimBLEPlatform.h and Trackball.h
2. `grep -c "DELAY RATIONALE" src/BLE/platforms/NimBLEPlatform.cpp` returns >= 10
3. `grep "Timing and Volatile Reference" docs/CONCURRENCY.md` returns match
4. Native build compiles successfully (comments only, no code changes)
</verification>

<success_criteria>
- CONC-L1 complete: All volatile variables documented with rationale
- CONC-L2 complete: All delay() calls documented with rationale
- CONCURRENCY.md has reference table for quick lookup
- No functional code changes, documentation only
</success_criteria>

<output>
After completion, create `.planning/phases/08-p3-optimization-hardening/08-03-SUMMARY.md`
</output>
