---
phase: 08-p3-optimization-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Bytes.cpp
  - src/LXMF/MessageStore.cpp
autonomous: true

must_haves:
  truths:
    - "toHex reserves string capacity before building, eliminating reallocs"
    - "MessageStore uses ArduinoJson v7 API (operator[] + is<T> instead of containsKey)"
  artifacts:
    - path: "src/Bytes.cpp"
      provides: "toHex with capacity reservation"
      contains: "hex.reserve"
    - path: "src/LXMF/MessageStore.cpp"
      provides: "ArduinoJson v7 API migration"
      pattern: "\\[.*\\]\\.is<"
  key_links: []
---

<objective>
Fix trivial P3 memory optimization issues that require minimal code changes.

Purpose: Complete MEM-L1 (toHex capacity reservation) and migrate remaining deprecated ArduinoJson v6 API calls in MessageStore.cpp to v7 patterns.

Output: Two small code fixes that reduce heap fragmentation (toHex) and ensure API consistency (ArduinoJson).
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-p3-optimization-hardening/08-RESEARCH.md

# Source files
@src/Bytes.cpp (toHex function around line 168)
@src/LXMF/MessageStore.cpp (containsKey usage at lines 174, 371)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add capacity reservation to toHex</name>
  <files>src/Bytes.cpp</files>
  <action>
    In the toHex function (around line 168):
    1. After the empty check (`if (!_data) return "";`), before creating the hex string
    2. Add `hex.reserve(_data->size() * 2);` to pre-allocate the exact capacity needed
    3. Remove the FIXME comment about reallocs (it's now fixed)
    4. Remove the "Consider:" comment about reserve (it's now implemented)

    The function builds a string by appending 2 hex chars per byte, so `size * 2` is exact.
  </action>
  <verify>
    Grep for `hex.reserve` in src/Bytes.cpp to confirm it exists.
    Build the native target to verify compilation.
  </verify>
  <done>
    toHex reserves exactly `_data->size() * 2` capacity before building hex string.
    FIXME comment removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate MessageStore to ArduinoJson v7 API</name>
  <files>src/LXMF/MessageStore.cpp</files>
  <action>
    The deprecated ArduinoJson v6 API `containsKey()` should be replaced with the v7 pattern.

    At line 174:
    - Change `if (conv.containsKey("last_message_hash"))` to `if (conv["last_message_hash"].is<JsonVariantConst>())`
    - Or use the simpler pattern: `if (!conv["last_message_hash"].isNull())`

    At line 371:
    - Change `if (_json_doc.containsKey("incoming"))` to `if (!_json_doc["incoming"].isNull())`

    ArduinoJson v7 migration guide: containsKey("key") -> operator[]("key").is<T>() or isNull() check.
    Use `!isNull()` for existence checks, use `.is<SpecificType>()` for type-safe checks.
  </action>
  <verify>
    Run: `grep -n "containsKey" src/LXMF/MessageStore.cpp` - should return no matches.
    Build the native target to verify compilation.
  </verify>
  <done>
    No containsKey calls remain in MessageStore.cpp.
    ArduinoJson v7 API patterns used consistently.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "containsKey" src/` returns only expected results (if any remain elsewhere, document)
2. `grep -n "hex.reserve" src/Bytes.cpp` shows the reservation line
3. Native build compiles successfully: `pio run -e native`
</verification>

<success_criteria>
- MEM-L1 complete: toHex pre-allocates exact capacity
- ArduinoJson v7 API: No deprecated containsKey in MessageStore.cpp
- Both changes compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-p3-optimization-hardening/08-01-SUMMARY.md`
</output>
