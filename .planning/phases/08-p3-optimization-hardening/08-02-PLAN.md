---
phase: 08-p3-optimization-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/UI/LVGL/LVGLInit.cpp
autonomous: true

must_haves:
  truths:
    - "All portMAX_DELAY mutex sites have debug timeout variants"
    - "Debug builds log warning on 5s timeout then continue waiting"
    - "Release builds use portMAX_DELAY (unchanged behavior)"
  artifacts:
    - path: "src/UI/LVGL/LVGLInit.cpp"
      provides: "Debug timeout in lvgl_task loop"
      contains: "#ifndef NDEBUG"
  key_links:
    - from: "src/UI/LVGL/LVGLInit.cpp"
      to: "src/UI/LVGL/LVGLLock.h"
      via: "Same debug timeout pattern"
      pattern: "pdMS_TO_TICKS.*5000"
---

<objective>
Extend the Phase 7 debug timeout pattern to all remaining portMAX_DELAY sites.

Purpose: Complete CONC-L4 by ensuring all mutex acquisition sites in the codebase have debug-time stuck task detection (5s timeout with warning log, then continue).

Output: All portMAX_DELAY sites wrapped in debug conditional with 5s timeout + warning logging.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-p3-optimization-hardening/08-RESEARCH.md

# Reference implementation from Phase 7
@src/UI/LVGL/LVGLLock.h (debug timeout pattern at line 46-62)

# Site to update
@src/UI/LVGL/LVGLInit.cpp (portMAX_DELAY at line 162)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add debug timeout to lvgl_task mutex acquisition</name>
  <files>src/UI/LVGL/LVGLInit.cpp</files>
  <action>
    At line 162, the lvgl_task loop uses `xSemaphoreTakeRecursive(_mutex, portMAX_DELAY)`.

    Replace the mutex acquisition with the Phase 7 debug timeout pattern:

    ```cpp
    #ifndef NDEBUG
                // Debug builds: 5-second timeout for stuck task detection
                BaseType_t result = xSemaphoreTakeRecursive(_mutex, pdMS_TO_TICKS(5000));
                if (result != pdTRUE) {
                    WARNING("LVGL task mutex timeout (5s) - possible deadlock or stuck task");
                    // Per Phase 8 context: log warning and continue waiting (don't break functionality)
                    xSemaphoreTakeRecursive(_mutex, portMAX_DELAY);
                }
    #else
                xSemaphoreTakeRecursive(_mutex, portMAX_DELAY);
    #endif
    ```

    Key differences from LVGLLock.h pattern:
    - Use WARNING() instead of assert() - per user context "log warning and continue waiting"
    - Continue with portMAX_DELAY after warning - don't break functionality
    - This is the loop context, not RAII guard, so no _acquired flag needed

    Ensure the Log.h header is included for WARNING macro.
  </action>
  <verify>
    1. Grep for `portMAX_DELAY` in src/UI/LVGL/LVGLInit.cpp - should now be inside #ifndef NDEBUG block
    2. Grep for `pdMS_TO_TICKS(5000)` in src/UI/LVGL/LVGLInit.cpp - should exist
    3. Build the native target to verify compilation
  </verify>
  <done>
    lvgl_task mutex acquisition uses 5s debug timeout with warning log.
    Release builds unchanged (portMAX_DELAY).
    No functional changes to application behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify all portMAX_DELAY sites are covered</name>
  <files>N/A - verification only</files>
  <action>
    Run a comprehensive search for remaining portMAX_DELAY sites:
    ```bash
    grep -rn "portMAX_DELAY" src/
    ```

    For each result:
    1. If inside #ifndef NDEBUG block or has equivalent timeout - already handled
    2. If in LVGLLock.h - already handled (Phase 7)
    3. If in LVGLInit.cpp line 162 - handled by Task 1
    4. Any other sites - document in summary as potential future work

    Expected: Only the two sites (LVGLLock.h and LVGLInit.cpp) should have portMAX_DELAY, both now with debug wrappers.
  </action>
  <verify>
    All portMAX_DELAY sites are either:
    - Inside debug conditional with timeout, OR
    - Documented as intentionally infinite (with justification)
  </verify>
  <done>
    All portMAX_DELAY mutex acquisition sites have debug timeout variants.
    No undocumented infinite waits remain.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "portMAX_DELAY" src/UI/LVGL/` shows both sites wrapped in debug conditionals
2. `grep -rn "#ifndef NDEBUG" src/UI/LVGL/LVGLInit.cpp` confirms debug block exists
3. Native build compiles successfully: `pio run -e native`
</verification>

<success_criteria>
- CONC-L4 complete: All portMAX_DELAY sites have debug timeout variants
- Consistent with Phase 7 pattern (5s timeout, WARNING log)
- Release builds unaffected (portMAX_DELAY behavior preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/08-p3-optimization-hardening/08-02-SUMMARY.md`
</output>
