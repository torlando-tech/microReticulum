---
phase: 07-p2-production-readiness
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - examples/lxmf_tdeck/lib/tone/Tone.cpp
autonomous: true

must_haves:
  truths:
    - "I2S writes use 2000ms timeout instead of portMAX_DELAY"
    - "Timeout failures are logged with error level"
    - "Tone generation continues to work normally"
  artifacts:
    - path: "examples/lxmf_tdeck/lib/tone/Tone.cpp"
      provides: "Bounded I2S write timeout"
      contains: "pdMS_TO_TICKS(2000)"
  key_links:
    - from: "i2s_write"
      to: "timeout"
      via: "pdMS_TO_TICKS"
      pattern: "pdMS_TO_TICKS\\(2000\\)"
---

<objective>
Replace unbounded portMAX_DELAY with reasonable timeout for I2S audio writes.

Purpose: Prevent indefinite blocking on audio hardware issues (CONC-M8).
Output: I2S writes have 2-second timeout with error logging on failure.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-p2-production-readiness/07-CONTEXT.md
@.planning/phases/07-p2-production-readiness/07-RESEARCH.md

Source file:
@examples/lxmf_tdeck/lib/tone/Tone.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace portMAX_DELAY with bounded timeout in I2S writes</name>
  <files>examples/lxmf_tdeck/lib/tone/Tone.cpp</files>
  <action>
Modify all i2s_write calls to use a 2-second timeout instead of portMAX_DELAY:

1. Line 100 (in tone_play main loop):
BEFORE:
```cpp
        i2s_write(I2S_PORT, samples, sizeof(samples), &bytes_written, portMAX_DELAY);
```

AFTER:
```cpp
        esp_err_t err = i2s_write(I2S_PORT, samples, sizeof(samples), &bytes_written, pdMS_TO_TICKS(2000));
        if (err != ESP_OK) {
            Serial.printf("[TONE] I2S write timeout/error: %d\n", err);
            break;  // Abort tone on error
        }
```

2. Line 105 (silence flush after tone):
BEFORE:
```cpp
    int16_t silence[128] = {0};
    i2s_write(I2S_PORT, silence, sizeof(silence), &bytes_written, portMAX_DELAY);
```

AFTER:
```cpp
    int16_t silence[128] = {0};
    // Silence flush - timeout OK to ignore here
    i2s_write(I2S_PORT, silence, sizeof(silence), &bytes_written, pdMS_TO_TICKS(2000));
```

3. Line 118 (tone_stop silence):
BEFORE:
```cpp
    i2s_write(I2S_PORT, silence, sizeof(silence), &bytes_written, portMAX_DELAY);
```

AFTER:
```cpp
    // Silence on stop - timeout OK to ignore
    i2s_write(I2S_PORT, silence, sizeof(silence), &bytes_written, pdMS_TO_TICKS(2000));
```

Note: The #include <driver/i2s.h> already provides portMAX_DELAY and pdMS_TO_TICKS.
Note: Only the main write loop (line 100) needs error handling since that's where blocking is critical.
       The silence writes on lines 105 and 118 are best-effort - if they timeout, the tone already stopped.
  </action>
  <verify>
- Grep for `portMAX_DELAY` should return 0 matches in Tone.cpp
- Grep for `pdMS_TO_TICKS(2000)` should return 3 matches
- `pio run -e tdeck 2>&1 | grep -E "(error|warning)" | head -20` compiles without errors
  </verify>
  <done>All I2S writes use 2000ms timeout with error logging on main write loop</done>
</task>

</tasks>

<verification>
1. Full build compiles without errors: `pio run -e tdeck`
2. No portMAX_DELAY in Tone.cpp
3. Main write loop has error check and break on failure
4. All i2s_write calls use pdMS_TO_TICKS(2000)
</verification>

<success_criteria>
- Build succeeds with 0 errors
- No portMAX_DELAY usage in I2S writes
- Main write loop logs and breaks on timeout/error
- Requirements satisfied: CONC-M8
</success_criteria>

<output>
After completion, create `.planning/phases/07-p2-production-readiness/07-04-SUMMARY.md`
</output>
