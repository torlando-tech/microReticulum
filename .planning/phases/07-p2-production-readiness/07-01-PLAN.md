---
phase: 07-p2-production-readiness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/UI/LVGL/LVGLLock.h
  - src/UI/LXMF/SettingsScreen.cpp
  - src/UI/LXMF/ComposeScreen.cpp
  - src/UI/LXMF/AnnounceListScreen.cpp
autonomous: true

must_haves:
  truths:
    - "All LVGL screen constructors/destructors hold LVGL mutex during widget creation/deletion"
    - "Debug builds crash with diagnostics when LVGL mutex acquisition times out after 5s"
    - "Release builds wait indefinitely for LVGL mutex (production behavior)"
  artifacts:
    - path: "src/UI/LVGL/LVGLLock.h"
      provides: "Debug timeout for LVGL mutex"
      contains: "pdMS_TO_TICKS(5000)"
    - path: "src/UI/LXMF/SettingsScreen.cpp"
      provides: "LVGL_LOCK in constructor and destructor"
      contains: "LVGL_LOCK()"
    - path: "src/UI/LXMF/ComposeScreen.cpp"
      provides: "LVGL_LOCK in constructor and destructor"
      contains: "LVGL_LOCK()"
    - path: "src/UI/LXMF/AnnounceListScreen.cpp"
      provides: "LVGL_LOCK in constructor and destructor"
      contains: "LVGL_LOCK()"
  key_links:
    - from: "LVGLLock constructor"
      to: "xSemaphoreTakeRecursive"
      via: "timeout parameter"
      pattern: "pdMS_TO_TICKS\\(5000\\)"
---

<objective>
Add LVGL_LOCK to missing screen constructors/destructors and implement debug timeout for LVGL mutex.

Purpose: Fix race conditions during screen transitions (CONC-M1, CONC-M2, CONC-M3) and enable deadlock detection in debug builds (CONC-M7).
Output: Thread-safe screen creation/destruction with debug-time deadlock detection.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-p2-production-readiness/07-CONTEXT.md
@.planning/phases/07-p2-production-readiness/07-RESEARCH.md

Source files to modify:
@src/UI/LVGL/LVGLLock.h
@src/UI/LXMF/SettingsScreen.cpp
@src/UI/LXMF/ComposeScreen.cpp
@src/UI/LXMF/AnnounceListScreen.cpp

Reference (already has correct pattern):
@src/UI/LXMF/ChatScreen.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add debug timeout to LVGL mutex acquisition</name>
  <files>src/UI/LVGL/LVGLLock.h</files>
  <action>
Modify the LVGLLock constructor to use a 5-second timeout in debug builds:

1. In the constructor, after `if (mutex) {`, add conditional compilation:
   - For DEBUG builds: Use `xSemaphoreTakeRecursive(mutex, pdMS_TO_TICKS(5000))`
   - Check return value; if not pdTRUE, log error with mutex holder info and assert
   - Use `xSemaphoreGetMutexHolder(mutex)` to identify holder if available
   - For non-DEBUG builds: Keep existing `portMAX_DELAY` behavior

2. Use `#ifdef NDEBUG` to detect release builds (NDEBUG is defined in release, not in debug)
   - Debug path: #ifndef NDEBUG
   - Release path: #else

3. Include diagnostic info in debug crash:
   - Log "LVGL mutex timeout (5s) - possible deadlock"
   - Use assert(false && "LVGL mutex deadlock") for immediate crash

Do NOT modify the destructor (it only releases, no timeout needed).
  </action>
  <verify>
- Inspect modified LVGLLock.h to confirm:
  - Debug path uses pdMS_TO_TICKS(5000)
  - Release path uses portMAX_DELAY
  - Debug path has assert on timeout
- `pio run -e tdeck 2>&1 | grep -E "(error|warning)" | head -20` compiles without errors
  </verify>
  <done>LVGLLock uses 5s timeout in debug builds with crash on failure, portMAX_DELAY in release</done>
</task>

<task type="auto">
  <name>Task 2: Add LVGL_LOCK to SettingsScreen constructor/destructor</name>
  <files>src/UI/LXMF/SettingsScreen.cpp</files>
  <action>
Add LVGL_LOCK() as the first statement in:

1. Constructor (around line 55):
   - Add `LVGL_LOCK();` immediately after the opening brace of the constructor body
   - BEFORE the `if (parent)` check
   - This protects all the lv_obj_create, lv_obj_set_size, etc. calls

2. Destructor (around line 105):
   - Add `LVGL_LOCK();` immediately after the opening brace
   - BEFORE the `if (_screen)` check
   - This protects the lv_obj_del call

Note: The file already includes `../LVGL/LVGLLock.h` so no include is needed.
Note: Do NOT add locks to event callbacks (on_back_clicked, on_save_clicked, etc.) - they already run within LVGL task handler.
  </action>
  <verify>
- Grep for LVGL_LOCK in constructor and destructor
- `pio run -e tdeck 2>&1 | grep -E "(error|warning)" | head -20` compiles without errors
  </verify>
  <done>SettingsScreen constructor and destructor have LVGL_LOCK</done>
</task>

<task type="auto">
  <name>Task 3: Add LVGL_LOCK to ComposeScreen constructor/destructor</name>
  <files>src/UI/LXMF/ComposeScreen.cpp</files>
  <action>
Add LVGL_LOCK() as the first statement in:

1. Constructor (line 19-48):
   - Add `LVGL_LOCK();` immediately after the initializer list and opening brace
   - Specifically after line 22's ` _btn_cancel(nullptr), _btn_send(nullptr), _btn_back(nullptr) {`
   - BEFORE the `// Create screen object` comment

2. Destructor (line 50-54):
   - Add `LVGL_LOCK();` immediately after the opening brace on line 50
   - BEFORE the `if (_screen)` check

Note: The file already includes `../LVGL/LVGLLock.h` so no include is needed.
Note: Other methods like clear(), show(), hide() already have LVGL_LOCK - do not add duplicate locks.
  </action>
  <verify>
- Grep for LVGL_LOCK in constructor and destructor
- `pio run -e tdeck 2>&1 | grep -E "(error|warning)" | head -20` compiles without errors
  </verify>
  <done>ComposeScreen constructor and destructor have LVGL_LOCK</done>
</task>

<task type="auto">
  <name>Task 4: Add LVGL_LOCK to AnnounceListScreen constructor/destructor</name>
  <files>src/UI/LXMF/AnnounceListScreen.cpp</files>
  <action>
Add LVGL_LOCK() as the first statement in:

1. Constructor (lines 23-50):
   - Add `LVGL_LOCK();` after the initializer list and opening brace
   - Specifically after line 25's ` _btn_back(nullptr), _btn_refresh(nullptr), _btn_announce(nullptr), _empty_label(nullptr) {`
   - BEFORE the `// Create screen object` comment on line 27

2. Destructor (lines 52-56):
   - Add `LVGL_LOCK();` immediately after the opening brace on line 52
   - BEFORE the `if (_screen)` check

Note: The file already includes `../LVGL/LVGLLock.h` so no include is needed.
Note: Other methods like refresh(), show(), hide() already have LVGL_LOCK - do not add duplicate locks.
  </action>
  <verify>
- Grep for LVGL_LOCK in constructor and destructor
- `pio run -e tdeck 2>&1 | grep -E "(error|warning)" | head -20` compiles without errors
  </verify>
  <done>AnnounceListScreen constructor and destructor have LVGL_LOCK</done>
</task>

</tasks>

<verification>
1. Full build compiles without errors: `pio run -e tdeck`
2. Grep confirms LVGL_LOCK in all three screen constructors and destructors
3. LVGLLock.h has both debug timeout (5000ms) and release (portMAX_DELAY) paths
</verification>

<success_criteria>
- Build succeeds with 0 errors
- All three screens (SettingsScreen, ComposeScreen, AnnounceListScreen) have LVGL_LOCK in constructor AND destructor
- LVGLLock.h uses pdMS_TO_TICKS(5000) in debug builds, portMAX_DELAY in release builds
- Requirements satisfied: CONC-M1, CONC-M2, CONC-M3, CONC-M7
</success_criteria>

<output>
After completion, create `.planning/phases/07-p2-production-readiness/07-01-SUMMARY.md`
</output>
