---
phase: 03-memory-allocation-audit
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/LXMF/MessageStore.cpp
  - src/LXMF/MessageStore.h
  - src/Utilities/Persistence.cpp
  - src/Utilities/Persistence.h
autonomous: true

must_haves:
  truths:
    - "All ArduinoJson document usage documented (Dynamic vs Static vs JsonDocument)"
    - "Deprecated ArduinoJson 6 patterns identified"
    - "JSON document sizes and reuse patterns documented"
  artifacts:
    - path: ".planning/phases/03-memory-allocation-audit/03-03-FINDINGS.md"
      provides: "ArduinoJson usage audit and persistence layer analysis"
      contains: "MEM-05"
  key_links:
    - from: "src/LXMF/MessageStore.h"
      to: "JsonDocument"
      via: "_json_doc member reuse"
      pattern: "JsonDocument _json_doc"
---

<objective>
Audit ArduinoJson usage patterns and persistence layer allocations.

Purpose: ArduinoJson is a key allocation source for configuration and message storage. Identifying deprecated patterns and verifying proper document reuse completes MEM-05.

Output: Findings document with ArduinoJson pattern analysis and migration recommendations.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-memory-allocation-audit/03-CONTEXT.md
@.planning/phases/03-memory-allocation-audit/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit ArduinoJson usage across codebase</name>
  <files>src/LXMF/MessageStore.cpp, src/LXMF/MessageStore.h, src/Utilities/Persistence.cpp, src/Utilities/Persistence.h</files>
  <action>
    Comprehensive ArduinoJson audit:

    1. Search entire codebase for ArduinoJson patterns:
       ```bash
       grep -rn "JsonDocument\|DynamicJsonDocument\|StaticJsonDocument" src/
       grep -rn "deserializeJson\|serializeJson" src/
       ```

    2. MessageStore.h/cpp audit (GOOD pattern per research):
       - Verify _json_doc is reused (not recreated)
       - Document clear() pattern before each use
       - Note document sizes (DOCUMENT_MAXSIZE = 8192)

    3. Persistence.h/cpp audit (LEGACY pattern per research):
       - Find DynamicJsonDocument usage (deprecated in v7)
       - Document document sizes
       - Note if documents are static or recreated

    4. Pattern classification:
       - JsonDocument (v7 correct) - note reuse
       - DynamicJsonDocument (v6 deprecated) - flag for migration
       - StaticJsonDocument (v6 deprecated) - flag for migration
       - Temporary documents (function-local) - note allocation overhead

    5. Size analysis:
       - DOCUMENT_MAXSIZE (8192 bytes) - verify this is appropriate
       - BUFFER_MAXSIZE (12288 bytes) - note relation to JSON
       - Check for documents larger than 1KB

    6. Add FIXME(frag) comments:
       - Deprecated API usage
       - Temporary documents that could be reused
       - Oversized documents
  </action>
  <verify>
    - All ArduinoJson usage sites found via grep
    - Deprecated patterns identified
    - Document sizes documented
    - Reuse patterns noted
  </verify>
  <done>
    Complete ArduinoJson usage inventory with pattern classification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit remaining UI and BLE allocations</name>
  <files>src/UI/*, src/BLE/*</files>
  <action>
    Quick audit of UI and BLE subsystems for significant allocations:

    1. UI subsystem scan:
       - UIManager.cpp: Note screen object allocations (startup-only)
       - Check for any per-frame or periodic allocations
       - Verify LVGL buffer PSRAM usage (documented in research)

    2. BLE subsystem scan:
       - BLEReassembler: Verify pool-based (per research)
       - BLEPeerManager: Verify pool-based
       - BLEIdentityManager: Verify pool-based
       - BLEFragmenter: Check for temporary buffers

    3. Note any unexpected allocations:
       - std::string concatenation in hot paths
       - Temporary vectors/maps
       - Large stack allocations

    4. This is a quick scan - focus on:
       - Allocations >512 bytes
       - Per-packet frequency allocations
       - Unbounded containers

    Document findings for inclusion in findings document.
  </action>
  <verify>
    - UI startup allocations documented
    - BLE pool-based architecture confirmed
    - Any unexpected allocations flagged
  </verify>
  <done>
    UI and BLE allocation patterns documented (startup-only confirmed for most).
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ArduinoJson and persistence findings document</name>
  <files>.planning/phases/03-memory-allocation-audit/03-03-FINDINGS.md</files>
  <action>
    Create findings document for MEM-05 (ArduinoJson):

    Structure:
    ```markdown
    # Phase 3 Plan 03: ArduinoJson and Persistence Audit Findings

    ## Executive Summary
    [ArduinoJson version (7.4.2), deprecated patterns found, key concerns]

    ## MEM-05: ArduinoJson Usage Audit

    ### ArduinoJson Version
    - Version in platformio.ini: 7.4.2
    - API compatibility: [v6 deprecated patterns found?]

    ### Usage Sites
    | File | Line | Pattern | Document Type | Size | Reused? | Severity |
    [Complete table]

    ### Deprecated Patterns
    | File | Line | Old Pattern | Recommended | Severity |
    [DynamicJsonDocument -> JsonDocument migrations]

    ### Document Reuse Analysis
    [Which documents are reused vs recreated]

    ### Size Analysis
    - DOCUMENT_MAXSIZE: 8192 bytes [appropriate?]
    - Largest document usage: [where, what size]

    ## UI Subsystem Summary
    [Startup-only allocations, LVGL PSRAM confirmed]

    ## BLE Subsystem Summary
    [Pool-based architecture confirmed]

    ## Issues by Severity

    ### Medium
    [Deprecated ArduinoJson API usage]

    ### Low
    [Minor optimization opportunities]

    ## ArduinoJson 7 Migration Checklist
    - [ ] Persistence.h: DynamicJsonDocument -> JsonDocument
    - [Additional items as found]

    ## Recommendations for Phase 5
    [Prioritized migration tasks]
    ```
  </action>
  <verify>
    - File exists at .planning/phases/03-memory-allocation-audit/03-03-FINDINGS.md
    - MEM-05 ArduinoJson audit complete
    - Migration checklist provided
    - UI/BLE summaries included
  </verify>
  <done>
    ArduinoJson audit complete with migration recommendations for Phase 5.
  </done>
</task>

</tasks>

<verification>
- All ArduinoJson usage sites documented
- Deprecated patterns identified with migration path
- Document sizes and reuse patterns analyzed
- UI and BLE allocations confirmed as startup-only/pool-based
- Findings document complete with migration checklist
</verification>

<success_criteria>
MEM-05 (ArduinoJson usage) complete.
UI and BLE allocation patterns confirmed.
Migration recommendations documented for Phase 5.
</success_criteria>

<output>
After completion, create `.planning/phases/03-memory-allocation-audit/03-03-SUMMARY.md`
</output>
