---
phase: 03-memory-allocation-audit
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Identity.cpp
  - src/Identity.h
  - src/Destination.cpp
  - src/Destination.h
  - src/Link.cpp
  - src/Link.h
  - src/Channel.cpp
  - src/Channel.h
  - src/Resource.cpp
  - src/Resource.h
autonomous: true

must_haves:
  truths:
    - "All shared_ptr creation sites in Identity/Destination/Link/Channel/Resource are documented"
    - "Pattern classification complete: new/shared_ptr vs make_shared usage"
    - "Allocation frequencies documented: startup-only, per-link, per-packet"
  artifacts:
    - path: ".planning/phases/03-memory-allocation-audit/03-02-FINDINGS.md"
      provides: "shared_ptr patterns and session-level allocation audit"
      contains: "MEM-03"
  key_links:
    - from: "src/Identity.cpp"
      to: "heap_caps_aligned_alloc"
      via: "PSRAM pool allocation"
      pattern: "MALLOC_CAP_SPIRAM"
---

<objective>
Audit shared_ptr allocation patterns and session-level objects (Identity, Destination, Link, Channel, Resource).

Purpose: These classes use the pimpl pattern with shared_ptr extensively. Auditing these patterns completes MEM-03 requirement and documents per-link allocation frequency.

Output: Findings document with shared_ptr pattern analysis and session-level allocation documentation.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-memory-allocation-audit/03-CONTEXT.md
@.planning/phases/03-memory-allocation-audit/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit Identity and Destination shared_ptr patterns</name>
  <files>src/Identity.cpp, src/Identity.h, src/Destination.cpp, src/Destination.h</files>
  <action>
    Audit shared_ptr usage in Identity and Destination:

    1. Identity class audit:
       - Count all `new Object()` wrapped in shared_ptr
       - Document pool allocations (known_destinations_pool, known_ratchets)
       - Verify PSRAM usage for pools (heap_caps_aligned_alloc)
       - Note crypto object allocations (keys, hashes)
       - Classify frequency: identity-recall vs startup

    2. Destination class audit:
       - Document all shared_ptr creation sites
       - Note any nested object allocations
       - Classify frequency: per-destination vs startup

    3. Pattern analysis:
       - Count `new T()` then `shared_ptr<T>(p)` pattern
       - Count `make_shared<T>()` pattern (if any)
       - Note impact: 2 allocations vs 1 for each pattern

    4. Cryptography subclass audit:
       - Check Ed25519.h, X25519.h, HMAC.h for `new` calls
       - Document key/hash object creation frequency

    5. Add FIXME(frag) comments for:
       - High-frequency new/shared_ptr that could use make_shared
       - Large allocations not using PSRAM
       - Unbounded containers

    Create detailed notes with file:line references.
  </action>
  <verify>
    - All shared_ptr sites in Identity.cpp/h documented
    - All shared_ptr sites in Destination.cpp/h documented
    - Pool PSRAM usage verified
    - Crypto allocations documented
  </verify>
  <done>
    Identity and Destination shared_ptr patterns fully documented with frequency classification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit Link, Channel, Resource session objects</name>
  <files>src/Link.cpp, src/Link.h, src/Channel.cpp, src/Channel.h, src/Resource.cpp, src/Resource.h</files>
  <action>
    Audit session-level object allocations:

    1. Link class audit:
       - Document all shared_ptr creation (LinkData, Token objects)
       - Document fixed pools (pending_requests, incoming_resources, outgoing_resources)
       - Note pool sizes and overflow behavior
       - Classify: per-link-establishment vs per-packet-on-link

    2. Channel class audit:
       - Document ChannelData allocation
       - Note any buffers or temporary allocations
       - Check for unbounded message queues

    3. Resource class audit:
       - Document ResourceData allocations (two constructors noted in research)
       - Note resource segment handling
       - Check for large buffer allocations (file transfers)

    4. Buffer.cpp/h quick scan:
       - Document stream buffer allocations
       - Check buffer sizes

    5. Pattern summary:
       - Total new/shared_ptr count
       - Total make_shared count
       - Frequency breakdown

    Add FIXME(frag) comments where appropriate.
  </action>
  <verify>
    - All shared_ptr sites in Link/Channel/Resource documented
    - Pool sizes and overflow behaviors noted
    - Frequency classifications complete
  </verify>
  <done>
    Session-level object allocation patterns documented with pool analysis.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create shared_ptr and session audit findings document</name>
  <files>.planning/phases/03-memory-allocation-audit/03-02-FINDINGS.md</files>
  <action>
    Create findings document for MEM-03 (shared_ptr patterns):

    Structure:
    ```markdown
    # Phase 3 Plan 02: shared_ptr and Session Object Audit Findings

    ## Executive Summary
    [Total shared_ptr sites, pattern distribution, key concerns]

    ## MEM-03: shared_ptr Allocation Patterns

    ### Pattern Distribution
    | Pattern | Count | Example | Impact |
    | new T() + shared_ptr | X | Identity.cpp:NN | 2 allocations |
    | make_shared<T>() | Y | - | 1 allocation |

    ### By Class

    #### Identity
    | Site | File:Line | Pattern | Frequency | Notes |
    [Table]

    #### Destination
    [Table]

    #### Link
    [Table]

    #### Channel
    [Table]

    #### Resource
    [Table]

    ### Cryptography Allocations
    [Ed25519, X25519, HMAC key/hash creation]

    ## MEM-06: PSRAM Verification (continued)

    ### Identity Pool PSRAM Usage
    - known_destinations_pool: [size, PSRAM verified]
    - known_ratchets: [size, PSRAM status]

    ## Session Object Lifecycle

    ### Allocation Frequency Summary
    | Category | Objects | Trigger | Lifetime |
    | Startup | [...] | Boot | Application |
    | Per-link | [...] | Link establish | Link duration |
    | Per-packet | [...] | Packet recv/send | Short |

    ## Issues by Severity

    ### Medium
    [new/shared_ptr -> make_shared opportunities]

    ### Low
    [Style improvements]

    ## Recommendations for Phase 5
    [Prioritized changes]
    ```
  </action>
  <verify>
    - File exists at .planning/phases/03-memory-allocation-audit/03-02-FINDINGS.md
    - Contains MEM-03 pattern analysis
    - Includes frequency breakdown
    - Has Phase 5 recommendations
  </verify>
  <done>
    shared_ptr pattern audit complete with comprehensive documentation of MEM-03.
  </done>
</task>

</tasks>

<verification>
- All shared_ptr creation sites documented across Identity, Destination, Link, Channel, Resource
- Pattern distribution counted (new/shared_ptr vs make_shared)
- Allocation frequencies classified
- PSRAM usage verified for Identity pools
- Findings document complete with severity ratings
</verification>

<success_criteria>
MEM-03 (shared_ptr patterns) complete.
MEM-06 (PSRAM verification) continued with Identity pool verification.
Session-level object allocation patterns documented.
</success_criteria>

<output>
After completion, create `.planning/phases/03-memory-allocation-audit/03-02-SUMMARY.md`
</output>
