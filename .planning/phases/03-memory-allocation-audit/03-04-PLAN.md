---
phase: 03-memory-allocation-audit
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-02", "03-03"]
files_modified:
  - .planning/phases/03-memory-allocation-audit/03-AUDIT.md
  - docs/MEMORY_AUDIT.md
autonomous: true

must_haves:
  truths:
    - "All memory pools documented with sizes, capacities, and overflow behaviors"
    - "Complete audit report consolidates findings from plans 01-03"
    - "Issues prioritized by severity with fix recommendations"
    - "Report copied to docs/MEMORY_AUDIT.md for long-term reference"
  artifacts:
    - path: ".planning/phases/03-memory-allocation-audit/03-AUDIT.md"
      provides: "Complete memory allocation audit report"
      contains: "MEM-03, MEM-04, MEM-05, MEM-06, MEM-07"
    - path: "docs/MEMORY_AUDIT.md"
      provides: "Long-term reference copy of audit"
      contains: "Phase 5 backlog"
  key_links:
    - from: ".planning/phases/03-memory-allocation-audit/03-AUDIT.md"
      to: "docs/MEMORY_AUDIT.md"
      via: "Copy for long-term reference"
      pattern: "identical content"
---

<objective>
Document all memory pools and create final consolidated audit report.

Purpose: Complete MEM-07 (memory pools documentation) and synthesize all findings from plans 01-03 into the definitive audit report with prioritized Phase 5 backlog.

Output: Complete audit report in phase directory and docs/ for long-term reference.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-memory-allocation-audit/03-CONTEXT.md
@.planning/phases/03-memory-allocation-audit/03-RESEARCH.md
@.planning/phases/03-memory-allocation-audit/03-01-SUMMARY.md
@.planning/phases/03-memory-allocation-audit/03-02-SUMMARY.md
@.planning/phases/03-memory-allocation-audit/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Complete memory pools documentation (MEM-07)</name>
  <files>src/Identity.h, src/Transport.h, src/LXMF/MessageStore.h, src/LXMF/LXMRouter.h, src/BLE/*.h</files>
  <action>
    Document all memory pools across the codebase:

    1. Search for pool patterns:
       ```bash
       grep -rn "POOL\|_pool\|Pool\|MAX_.*SLOTS\|MAX_.*SIZE" src/ --include="*.h"
       grep -rn "heap_caps_aligned_alloc\|heap_caps_malloc" src/
       ```

    2. For each pool found, document:
       - Pool name and location (file:line)
       - Data type stored
       - Capacity (number of slots)
       - Per-slot size (bytes)
       - Total memory footprint
       - Overflow behavior (cull-oldest, silent-drop, warning-log, ring-buffer)
       - PSRAM usage (yes/no/fallback)

    3. Known pools from research to verify:
       - Known Destinations (Identity.h): 192 slots, cull-oldest
       - Known Ratchets (Identity.h): 128 slots, cull-oldest
       - Message Hashes (MessageStore.h): 256 per conversation
       - Conversations (MessageStore.h): 32 conversations
       - Announce Table (Transport.h): 8 slots
       - Destinations Pool (Transport.h): DESTINATIONS_POOL defined
       - Link pools (Link.h): pending_requests, resources
       - Segment Accumulator: 32 accumulators, 64 segments
       - BLE pools: Reassembler, PeerManager, IdentityManager
       - Propagation Nodes: MAX_PROPAGATION_NODES
       - LXMF pools: Fields, Router links/proofs/outbound

    4. Calculate total pool memory footprint.

    5. Identify any pools missing overflow protection.

    Create detailed pool inventory for inclusion in final report.
  </action>
  <verify>
    - All pools from research list verified
    - Any additional pools discovered documented
    - Overflow behaviors confirmed
    - Total memory footprint calculated
  </verify>
  <done>
    Complete memory pool inventory with sizes, capacities, and overflow behaviors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create consolidated audit report (03-AUDIT.md)</name>
  <files>.planning/phases/03-memory-allocation-audit/03-AUDIT.md</files>
  <action>
    Create the definitive audit report consolidating all findings:

    Structure:
    ```markdown
    # microReticulum Memory Allocation Audit

    **Audit Date:** 2026-01-24
    **Phase:** 03-memory-allocation-audit
    **Auditor:** Claude (automated)

    ## Executive Summary

    [High-level findings: total issues by severity, key concerns, overall assessment]

    ## Audit Scope

    ### Requirements Covered
    - MEM-03: shared_ptr allocation patterns
    - MEM-04: Packet/Bytes allocation frequency and sizes
    - MEM-05: ArduinoJson usage
    - MEM-06: PSRAM allocation strategy
    - MEM-07: Memory pools documentation

    ### Files Audited
    [Complete list with categories]

    ## Findings by Requirement

    ### MEM-03: shared_ptr Patterns
    [Consolidated from 03-02-FINDINGS.md]

    ### MEM-04: Packet/Bytes Allocations
    [Consolidated from 03-01-FINDINGS.md]

    ### MEM-05: ArduinoJson Usage
    [Consolidated from 03-03-FINDINGS.md]

    ### MEM-06: PSRAM Verification
    [Consolidated from 03-01, 03-02 FINDINGS]

    ### MEM-07: Memory Pools
    [From Task 1 of this plan]

    ## Issue Summary

    ### By Severity
    | Severity | Count | Key Issues |
    | Critical | X | [list] |
    | High | Y | [list] |
    | Medium | Z | [list] |
    | Low | W | [list] |

    ### By Category
    | Category | Issues | Severity Range |
    | PSRAM usage | X | Critical-Medium |
    | shared_ptr pattern | Y | Medium-Low |
    | ArduinoJson | Z | Medium |
    | Pool overflow | W | High-Low |

    ## Inline Comments Added

    | File | Line | Comment |
    [List of all FIXME(frag) comments added during audit]

    ## Phase 5 Backlog

    ### Priority 1 (Critical)
    [Issues to fix first]

    ### Priority 2 (High)
    [Important improvements]

    ### Priority 3 (Medium)
    [Recommended changes]

    ### Priority 4 (Low)
    [Optional optimizations]

    ## Recommendations

    ### Immediate Actions
    [Quick wins that could be done now]

    ### Architectural Considerations
    [Larger changes for Phase 5 planning]

    ---
    *Generated by Phase 3 Memory Allocation Audit*
    *Source: .planning/phases/03-memory-allocation-audit/*
    ```

    Pull data from 03-01-FINDINGS.md, 03-02-FINDINGS.md, 03-03-FINDINGS.md, and Task 1 pools.
  </action>
  <verify>
    - File exists at .planning/phases/03-memory-allocation-audit/03-AUDIT.md
    - All five MEM requirements addressed
    - Issues consolidated and prioritized
    - Phase 5 backlog created
  </verify>
  <done>
    Complete audit report created with all findings consolidated.
  </done>
</task>

<task type="auto">
  <name>Task 3: Copy report to docs/ for long-term reference</name>
  <files>docs/MEMORY_AUDIT.md</files>
  <action>
    Copy the audit report to docs/ directory:

    1. Create docs/ directory if it doesn't exist
    2. Copy 03-AUDIT.md to docs/MEMORY_AUDIT.md
    3. Update header to reflect it's a reference copy:
       - Add note: "This is a reference copy from .planning/phases/03-memory-allocation-audit/03-AUDIT.md"
       - Keep all content identical otherwise

    4. Verify the copy is complete and matches source.

    Per CONTEXT.md: "Phase directory is source of truth, copy to docs/ for long-term reference"
  </action>
  <verify>
    - docs/ directory exists
    - docs/MEMORY_AUDIT.md exists
    - Content matches 03-AUDIT.md (with reference note added)
  </verify>
  <done>
    Audit report available in docs/MEMORY_AUDIT.md for long-term reference.
  </done>
</task>

</tasks>

<verification>
- MEM-07 (memory pools) fully documented
- Consolidated audit report exists at 03-AUDIT.md
- All five MEM requirements addressed in report
- Issues prioritized by severity
- Phase 5 backlog created with fix recommendations
- Reference copy at docs/MEMORY_AUDIT.md
</verification>

<success_criteria>
All Phase 3 requirements complete:
- MEM-03: shared_ptr patterns audited
- MEM-04: Packet/Bytes allocations documented
- MEM-05: ArduinoJson usage audited
- MEM-06: PSRAM strategy verified
- MEM-07: Memory pools documented

Deliverables:
- 03-AUDIT.md with complete findings
- docs/MEMORY_AUDIT.md reference copy
- Phase 5 backlog ready for synthesis
</success_criteria>

<output>
After completion, create `.planning/phases/03-memory-allocation-audit/03-04-SUMMARY.md`
</output>
