---
phase: 03-memory-allocation-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Bytes.cpp
  - src/Bytes.h
  - src/Packet.cpp
  - src/Packet.h
  - src/Transport.cpp
  - src/Transport.h
autonomous: true

must_haves:
  truths:
    - "All Bytes allocation sites documented with frequency and size estimates"
    - "All Packet creation patterns documented with fragmentation risk"
    - "PSRAM usage verified for Bytes backing storage"
    - "Large allocations (>1KB) identified and flagged"
  artifacts:
    - path: ".planning/phases/03-memory-allocation-audit/03-01-FINDINGS.md"
      provides: "Core data path audit findings"
      contains: "MEM-04"
  key_links:
    - from: "src/Bytes.h"
      to: "PSRAMAllocator"
      via: "using Data = std::vector<uint8_t, PSRAMAllocator<uint8_t>>"
      pattern: "PSRAMAllocator"
---

<objective>
Audit core data path memory allocations (Bytes, Packet, Transport) for fragmentation risks.

Purpose: These files handle per-packet allocations - the highest frequency allocation path in the codebase. Identifying fragmentation issues here has the greatest impact on stability.

Output: Findings document with severity-rated issues and inline FIXME(frag) comments where issues found.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-memory-allocation-audit/03-CONTEXT.md
@.planning/phases/03-memory-allocation-audit/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit Bytes class allocation patterns</name>
  <files>src/Bytes.cpp, src/Bytes.h</files>
  <action>
    Audit the Bytes class for memory allocation patterns:

    1. Document all allocation sites:
       - `new Data()` calls in newData() and exclusiveData()
       - shared_ptr creation patterns
       - Vector operations that may reallocate (resize, push_back, reserve)

    2. Verify PSRAM usage:
       - Confirm Data typedef uses PSRAMAllocator
       - Check for any allocations bypassing PSRAMAllocator

    3. Analyze copy-on-write behavior:
       - When does exclusiveData() trigger copy?
       - What sizes are typical for copies?

    4. Document findings with severity:
       - Critical: >1KB heap allocation without PSRAM
       - High: Per-packet allocation that could use pooling
       - Medium: new/shared_ptr that could use make_shared
       - Low: Minor optimizations

    5. Add inline comments where issues found:
       Format: `// FIXME(frag): description`

    Document findings in a temporary notes section at end of task.
  </action>
  <verify>
    - All `new` and `shared_ptr` sites in Bytes.cpp/h are documented
    - PSRAM usage pattern is confirmed
    - Any FIXME(frag) comments added are syntactically valid
  </verify>
  <done>
    Bytes class allocation patterns fully documented with severity ratings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit Packet class and Transport allocations</name>
  <files>src/Packet.cpp, src/Packet.h, src/Transport.cpp, src/Transport.h</files>
  <action>
    Audit Packet and Transport for memory allocation patterns:

    1. Packet class audit:
       - Document all `new Object()` / shared_ptr sites
       - Document Bytes usage for packet data
       - Identify packet creation frequency paths (high/medium/low)
       - Note packet lifecycle (create, process, destroy timing)

    2. Transport class audit:
       - Document pool usage (announce table, destinations pool, etc.)
       - Identify any unbounded containers (std::vector, std::map growth)
       - Check for large temporary buffers
       - Verify pools have overflow handling

    3. Size analysis:
       - Document MTU (500), MDU (~463), encryption overhead
       - Flag any allocations larger than MTU without PSRAM

    4. Frequency classification:
       - Per-packet: Every incoming/outgoing packet
       - Per-announce: Network announcements
       - Per-link: Link establishment
       - Startup-only: One-time initialization

    5. Add inline FIXME(frag) comments where issues found.

    Document findings with file, line, pattern, frequency, size estimate, and severity.
  </action>
  <verify>
    - All allocation patterns in Packet.cpp/h documented
    - All allocation patterns in Transport.cpp/h documented
    - Pool overflow behaviors documented
  </verify>
  <done>
    Packet and Transport allocation patterns documented with fragmentation risk assessment.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create core data path findings document</name>
  <files>.planning/phases/03-memory-allocation-audit/03-01-FINDINGS.md</files>
  <action>
    Create findings document consolidating Tasks 1 and 2:

    Structure:
    ```markdown
    # Phase 3 Plan 01: Core Data Path Audit Findings

    ## Executive Summary
    [Brief overview: X issues found, Y critical/high, key concerns]

    ## MEM-04: Packet/Bytes Allocation Patterns

    ### Bytes Class
    | Site | File:Line | Pattern | Frequency | Size | Severity | Issue |
    [Table of all allocation sites]

    ### Packet Class
    [Same table format]

    ### Transport Class
    [Same table format]

    ## MEM-06: PSRAM Verification (partial)

    ### Verified Using PSRAM
    [List of allocations correctly using PSRAM]

    ### Missing PSRAM (if any)
    [Critical issues - large allocations not using PSRAM]

    ## Issues by Severity

    ### Critical
    [List with fix recommendations]

    ### High
    [List with fix recommendations]

    ### Medium
    [List with fix recommendations]

    ### Low
    [List with fix recommendations]

    ## Recommendations for Phase 5
    [Prioritized fix list with complexity estimates]
    ```

    Use data from Tasks 1 and 2. Include specific line numbers and code patterns.
  </action>
  <verify>
    - File exists at .planning/phases/03-memory-allocation-audit/03-01-FINDINGS.md
    - Contains sections for Bytes, Packet, Transport
    - Issues are severity-rated
    - Includes fix recommendations
  </verify>
  <done>
    Core data path findings document complete with severity ratings and Phase 5 recommendations.
  </done>
</task>

</tasks>

<verification>
- All allocation sites in Bytes, Packet, Transport are documented
- PSRAM usage is verified for Bytes backing storage
- Issues are classified by severity (Critical/High/Medium/Low)
- Inline FIXME(frag) comments added where issues found
- Findings document exists with complete analysis
</verification>

<success_criteria>
MEM-04 (Packet/Bytes allocation patterns) partially complete.
MEM-06 (PSRAM verification) partially complete.
Core data path audit findings documented with severity ratings.
</success_criteria>

<output>
After completion, create `.planning/phases/03-memory-allocation-audit/03-01-SUMMARY.md`
</output>
