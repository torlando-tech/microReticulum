---
phase: 02-boot-profiling
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - src/Instrumentation/BootProfiler.h
  - src/Instrumentation/BootProfiler.cpp
  - examples/lxmf_tdeck/src/main.cpp
autonomous: false

must_haves:
  truths:
    - "Boot profile is persisted to SPIFFS file"
    - "Last 5 boot profiles are retained with rotation"
    - "Boot time target of 5 seconds is validated"
  artifacts:
    - path: "src/Instrumentation/BootProfiler.cpp"
      provides: "SPIFFS persistence for boot profiles"
      contains: "SPIFFS"
    - path: "examples/lxmf_tdeck/src/main.cpp"
      provides: "Boot profile save call"
      contains: "saveToFile"
  key_links:
    - from: "src/Instrumentation/BootProfiler.cpp"
      to: "SPIFFS filesystem"
      via: "File write operations"
      pattern: "SPIFFS.open"
---

<objective>
Add boot profile persistence to SPIFFS with file rotation and validate the 5-second boot target.

Purpose: Capture boot profiles for analysis across reboots, enable before/after comparison, and confirm optimizations achieve the target boot time.

Output: BootProfiler enhanced with SPIFFS persistence, file rotation logic, and a checkpoint to validate boot time meets 5-second target.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-boot-profiling/02-01-SUMMARY.md
@.planning/phases/02-boot-profiling/02-02-SUMMARY.md
@.planning/phases/02-boot-profiling/02-03-SUMMARY.md
@src/Instrumentation/BootProfiler.h
@src/Instrumentation/BootProfiler.cpp
@examples/lxmf_tdeck/src/main.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add file persistence to BootProfiler</name>
  <files>src/Instrumentation/BootProfiler.h, src/Instrumentation/BootProfiler.cpp</files>
  <action>
Enhance BootProfiler to save boot profiles to SPIFFS:

**In BootProfiler.h:**

1. Add new method declarations:
   - `static bool saveToFile()` - Save current boot profile to SPIFFS
   - `static void setFilesystemReady(bool ready)` - Called when SPIFFS is mounted

2. Add convenience macro:
   - `BOOT_PROFILE_SAVE()` (and no-op stub when disabled)

3. Add private members:
   - `static bool _fs_ready` - Track if SPIFFS is available
   - `static constexpr int MAX_BOOT_LOGS = 5` - Number of profiles to retain

**In BootProfiler.cpp:**

1. Add includes:
   - `#include <SPIFFS.h>` (only needed for file operations)

2. Implement saveToFile():
   ```cpp
   bool BootProfiler::saveToFile() {
       if (!_fs_ready) {
           Serial.println("[BOOT] Cannot save: filesystem not ready");
           return false;
       }

       // Rotate existing files: boot_4.log -> delete, boot_3.log -> boot_4.log, etc.
       for (int i = MAX_BOOT_LOGS - 1; i > 0; i--) {
           char old_name[24], new_name[24];
           snprintf(old_name, sizeof(old_name), "/boot_%d.log", i);
           snprintf(new_name, sizeof(new_name), "/boot_%d.log", i + 1);

           if (SPIFFS.exists(old_name)) {
               if (i == MAX_BOOT_LOGS - 1) {
                   SPIFFS.remove(old_name);  // Delete oldest
               } else {
                   SPIFFS.rename(old_name, new_name);
               }
           }
       }

       // Write current profile to boot_1.log (most recent)
       File f = SPIFFS.open("/boot_1.log", "w");
       if (!f) {
           Serial.println("[BOOT] Failed to create boot log file");
           return false;
       }

       // Write summary
       uint32_t total = millis() - _boot_start_ms;
       uint32_t init_time = total - _total_wait_ms;

       f.printf("Boot Profile - %lu ms total\n", total);
       f.printf("=====================================\n");
       f.printf("Init time: %lu ms\n", init_time);
       f.printf("Wait time: %lu ms\n", _total_wait_ms);
       f.printf("=====================================\n\n");

       // Write phase log (store phases as they complete for this)
       // For simplicity, just write the summary for now
       // Future enhancement: store per-phase data in memory and write here

       f.close();
       Serial.println("[BOOT] Profile saved to /boot_1.log");
       return true;
   }
   ```

3. Implement setFilesystemReady():
   ```cpp
   void BootProfiler::setFilesystemReady(bool ready) {
       _fs_ready = ready;
   }
   ```

4. Initialize static member:
   ```cpp
   bool BootProfiler::_fs_ready = false;
   ```
  </action>
  <verify>grep "saveToFile" src/Instrumentation/BootProfiler.h and src/Instrumentation/BootProfiler.cpp</verify>
  <done>BootProfiler can save profiles to SPIFFS with rotation of last 5 files</done>
</task>

<task type="auto">
  <name>Task 2: Integrate file persistence in main.cpp</name>
  <files>examples/lxmf_tdeck/src/main.cpp</files>
  <action>
Add calls to set filesystem ready and save boot profile:

1. In setup_hardware(), after filesystem is mounted successfully (around line 471), add:
```cpp
#ifdef BOOT_PROFILING_ENABLED
    RNS::Instrumentation::BootProfiler::setFilesystemReady(true);
#endif
```

2. At end of setup(), after BOOT_PROFILE_COMPLETE() call, add:
```cpp
#ifdef BOOT_PROFILING_ENABLED
    BOOT_PROFILE_SAVE();
#endif
```

This ensures:
- Filesystem flag is set as soon as SPIFFS is available
- Boot profile is saved after boot completes
- File rotation keeps only the last 5 profiles
  </action>
  <verify>grep "setFilesystemReady\|BOOT_PROFILE_SAVE" examples/lxmf_tdeck/src/main.cpp</verify>
  <done>Boot profile persistence integrated into startup sequence</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete boot profiling system with:
1. BootProfiler module for timing all setup phases
2. Instrumented setup() with START/END and WAIT markers
3. ESP-IDF configuration optimizations (PSRAM test disabled, reduced bootloader logging)
4. SPIFFS persistence with file rotation
  </what-built>
  <how-to-verify>
1. Build the T-Deck firmware:
   ```
   cd examples/lxmf_tdeck && pio run -e tdeck
   ```

2. Flash to device and open serial monitor:
   ```
   pio run -e tdeck -t upload && pio device monitor
   ```

3. Observe boot output - you should see:
   - `[BOOT] START: hardware`
   - `[BOOT] END: hardware (XXXms, cumulative: XXXms)`
   - Similar for each phase
   - `[BOOT] WAIT: wifi_connect (XXXms)` for blocking waits
   - `[BOOT] COMPLETE: total=XXXms, init=XXXms, wait=XXXms`
   - `[BOOT] Profile saved to /boot_1.log`

4. Check total boot time:
   - **TARGET: Under 5 seconds** (excluding wait time if network unavailable)
   - Note actual total time
   - Note init time vs wait time breakdown

5. If total time > 5 seconds:
   - Check which phases take longest
   - Consider enabling BOOT_REDUCED_LOGGING
   - Report findings for further optimization

6. To view saved profile, use serial commands or check SPIFFS:
   ```
   # After reboot, previous profile is in boot_1.log, older in boot_2.log, etc.
   ```
  </how-to-verify>
  <resume-signal>
Report boot time results:
- Total boot time: XXX ms
- Init time: XXX ms
- Wait time: XXX ms
- Longest phase: XXX (XXX ms)
- Type "VALIDATED" if under 5 seconds init time, or describe issues for next iteration
  </resume-signal>
</task>

</tasks>

<verification>
- BootProfiler has saveToFile() and setFilesystemReady() methods
- main.cpp calls setFilesystemReady after SPIFFS mount
- main.cpp calls BOOT_PROFILE_SAVE() at end of setup
- File rotation keeps only 5 most recent profiles
- Boot time measured and compared against 5-second target
</verification>

<success_criteria>
- Boot profiles persist across reboots in SPIFFS
- File rotation prevents storage exhaustion
- Total init time (excluding network waits) is under 5 seconds
- If target not met, blocking issues are clearly identified
</success_criteria>

<output>
After completion, create `.planning/phases/02-boot-profiling/02-04-SUMMARY.md`
Include measured boot times and validation results.
</output>
