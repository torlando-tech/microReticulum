---
phase: 02-boot-profiling
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - examples/lxmf_tdeck/sdkconfig.defaults
  - examples/lxmf_tdeck/platformio.ini
  - .planning/phases/02-boot-profiling/BOOT_OPTIMIZATIONS.md
autonomous: true

must_haves:
  truths:
    - "PSRAM memory test is disabled to save boot time"
    - "Flash configuration is verified optimal (QIO mode)"
    - "Each optimization is independently toggleable"
    - "Optimizations are documented with expected impact"
  artifacts:
    - path: "examples/lxmf_tdeck/sdkconfig.defaults"
      provides: "ESP-IDF configuration overrides"
      contains: "SPIRAM_MEMTEST"
    - path: ".planning/phases/02-boot-profiling/BOOT_OPTIMIZATIONS.md"
      provides: "Documentation of all boot optimizations"
      contains: "Expected savings"
  key_links:
    - from: "examples/lxmf_tdeck/sdkconfig.defaults"
      to: "ESP-IDF build system"
      via: "sdkconfig.defaults override mechanism"
      pattern: "CONFIG_"
---

<objective>
Apply configuration optimizations to reduce boot time and document all changes.

Purpose: Implement the "quick wins" identified in research: disable PSRAM memory test, verify flash mode, reduce log verbosity during boot. Each optimization should be independently toggleable.

Output: sdkconfig.defaults created with ESP-IDF optimizations, platformio.ini updated with conditional log level, BOOT_OPTIMIZATIONS.md documenting all changes.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-boot-profiling/02-RESEARCH.md
@.planning/phases/02-boot-profiling/02-CONTEXT.md
@examples/lxmf_tdeck/platformio.ini
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sdkconfig.defaults with boot optimizations</name>
  <files>examples/lxmf_tdeck/sdkconfig.defaults</files>
  <action>
Create sdkconfig.defaults file in examples/lxmf_tdeck/ with ESP-IDF boot optimizations:

```
# Boot Time Optimizations for T-Deck
# These settings override ESP-IDF defaults to reduce boot time.
# See .planning/phases/02-boot-profiling/BOOT_OPTIMIZATIONS.md for details.

# Disable PSRAM memory test at boot (~2 seconds saved for 8MB PSRAM)
# The memory test verifies PSRAM integrity but is redundant for stable hardware.
# To re-enable for debugging: comment out this line or set to y
CONFIG_SPIRAM_MEMTEST=n

# Reduce bootloader log verbosity (saves serial output time)
# Bootloader messages are rarely needed in production
CONFIG_BOOTLOADER_LOG_LEVEL_WARN=y
CONFIG_BOOTLOADER_LOG_LEVEL=2

# Skip ROM bootloader output (saves serial time)
CONFIG_BOOT_ROM_LOG_ALWAYS_OFF=y
```

Note: Flash mode is already configured optimally in platformio.ini:
- board_build.flash_mode = qio (Quad I/O)
- board_build.arduino.memory_type = qio_opi (Octal PI for PSRAM)
No changes needed there.
  </action>
  <verify>File exists at examples/lxmf_tdeck/sdkconfig.defaults with CONFIG_SPIRAM_MEMTEST=n</verify>
  <done>ESP-IDF boot optimizations configured via sdkconfig.defaults</done>
</task>

<task type="auto">
  <name>Task 2: Add boot log level optimization to platformio.ini</name>
  <files>examples/lxmf_tdeck/platformio.ini</files>
  <action>
The current platformio.ini has CORE_DEBUG_LEVEL=3 (INFO) which outputs many log lines during boot.

Add a BOOT_REDUCED_LOGGING flag that can be enabled to reduce log verbosity:

In both environments, add after BOOT_PROFILING_ENABLED:

```
    ; Reduce log verbosity during boot for faster startup
    ; Set CORE_DEBUG_LEVEL=2 (WARNING) instead of 3 (INFO)
    ; Uncomment to enable reduced logging:
    ; -DBOOT_REDUCED_LOGGING
```

Note: We're making this opt-in for now because:
1. Full logging is valuable during development
2. Boot profiling needs to measure current state first
3. Can enable reduced logging after baseline captured

The actual log level change will be documented but not activated by default yet. The user can enable it after reviewing boot profile data.
  </action>
  <verify>grep "BOOT_REDUCED_LOGGING" examples/lxmf_tdeck/platformio.ini shows the commented flag</verify>
  <done>Log level optimization option documented in platformio.ini</done>
</task>

<task type="auto">
  <name>Task 3: Document all boot optimizations</name>
  <files>.planning/phases/02-boot-profiling/BOOT_OPTIMIZATIONS.md</files>
  <action>
Create comprehensive documentation of all boot optimizations:

```markdown
# Boot Optimizations - T-Deck Firmware

**Created:** 2026-01-23
**Phase:** 02-boot-profiling

## Overview

This document tracks all configuration changes made to optimize boot time.
Each optimization is independently toggleable to allow testing individual impact.

## Implemented Optimizations

### 1. Disable PSRAM Memory Test

**File:** `examples/lxmf_tdeck/sdkconfig.defaults`
**Setting:** `CONFIG_SPIRAM_MEMTEST=n`
**Expected savings:** ~2 seconds (250ms per MB for 8MB PSRAM)

The PSRAM memory test writes and reads patterns to verify memory integrity. While useful for detecting hardware issues, it adds significant time to boot. For stable production hardware, this test can be safely disabled.

**To re-enable:** Set `CONFIG_SPIRAM_MEMTEST=y` or remove the line from sdkconfig.defaults.

### 2. Reduce Bootloader Log Level

**File:** `examples/lxmf_tdeck/sdkconfig.defaults`
**Settings:**
- `CONFIG_BOOTLOADER_LOG_LEVEL_WARN=y`
- `CONFIG_BOOTLOADER_LOG_LEVEL=2`
- `CONFIG_BOOT_ROM_LOG_ALWAYS_OFF=y`

**Expected savings:** ~100-200ms

Reduces serial output during early boot stages. Bootloader messages are useful for debugging but add latency.

### 3. Application Log Level (Optional)

**File:** `examples/lxmf_tdeck/platformio.ini`
**Setting:** `CORE_DEBUG_LEVEL` (currently 3/INFO)
**Option:** Change to 2 (WARNING) or 1 (ERROR) for production

**Expected savings:** ~200-500ms depending on log volume

Not enabled by default to preserve debugging information during development.

**To enable:** Change `-DCORE_DEBUG_LEVEL=3` to `-DCORE_DEBUG_LEVEL=2`

## Verified Optimal Settings

These settings were verified as already optimal:

### Flash Mode Configuration

**File:** `examples/lxmf_tdeck/platformio.ini`
- `board_build.flash_mode = qio` (Quad I/O - fastest mode)
- `board_build.arduino.memory_type = qio_opi` (Octal PI for PSRAM)

No changes needed - already configured for maximum speed.

## Blocking Operations Identified

These are code-level issues that require refactoring (not configuration changes):

| Operation | Location | Current Timeout | Impact |
|-----------|----------|-----------------|--------|
| WiFi connect | setup_wifi() | 30 seconds | Blocks if no WiFi |
| GPS time sync | setup() | 15 seconds | Blocks if no GPS fix |
| TCP stabilization | setup_lxmf() | 3 seconds fixed | Always blocks |

Recommendations:
1. Reduce WiFi timeout to 10 seconds
2. Move GPS sync to background or reduce timeout to 5 seconds
3. Reduce TCP delay to 1 second or use connection callback

These are tracked for potential future optimization but not implemented in this phase.

## Validation

After applying optimizations, run boot profiling to measure actual improvement:

1. Build with `BOOT_PROFILING_ENABLED`
2. Capture serial output during boot
3. Compare total boot time to baseline
4. Document results in this file

## Baseline Measurements

_To be filled after boot profiling data collection_

| Phase | Before Optimization | After Optimization |
|-------|--------------------|--------------------|
| Total boot | TBD | TBD |
| PSRAM test | TBD | Disabled |
| Bootloader logs | TBD | TBD |

---
*Last updated: 2026-01-23*
```
  </action>
  <verify>File exists at .planning/phases/02-boot-profiling/BOOT_OPTIMIZATIONS.md with all sections</verify>
  <done>All boot optimizations documented with expected impact and how to toggle each</done>
</task>

</tasks>

<verification>
- sdkconfig.defaults exists with SPIRAM_MEMTEST=n
- platformio.ini has documented log level option
- BOOT_OPTIMIZATIONS.md covers all implemented and planned optimizations
- Flash mode verified as optimal (already QIO)
- Each optimization has clear enable/disable instructions
</verification>

<success_criteria>
- Configuration optimizations applied to reduce boot time
- All changes documented with expected impact
- Optimizations independently toggleable for testing
- Blocking operations identified and documented for future work
</success_criteria>

<output>
After completion, create `.planning/phases/02-boot-profiling/02-03-SUMMARY.md`
</output>
