---
phase: 02-boot-profiling
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - examples/lxmf_tdeck/platformio.ini
  - examples/lxmf_tdeck/src/main.cpp
autonomous: true

must_haves:
  truths:
    - "Every setup function is individually timed"
    - "Blocking waits are tracked separately from init work"
    - "Build flag toggles all instrumentation on/off"
  artifacts:
    - path: "examples/lxmf_tdeck/platformio.ini"
      provides: "BOOT_PROFILING_ENABLED build flag"
      contains: "BOOT_PROFILING_ENABLED"
    - path: "examples/lxmf_tdeck/src/main.cpp"
      provides: "Instrumented setup() with profiling calls"
      contains: "BOOT_PROFILE_"
  key_links:
    - from: "examples/lxmf_tdeck/src/main.cpp"
      to: "src/Instrumentation/BootProfiler.h"
      via: "#include and macro calls"
      pattern: "BOOT_PROFILE_START"
---

<objective>
Instrument the T-Deck setup() sequence with BootProfiler timing calls around each init function.

Purpose: Collect baseline boot timing data to identify which phases take the longest and where blocking waits occur.

Output: main.cpp instrumented with timing calls, build flag added to platformio.ini.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-boot-profiling/02-01-SUMMARY.md
@examples/lxmf_tdeck/src/main.cpp (current setup structure)
@examples/lxmf_tdeck/platformio.ini (build flags location)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add BOOT_PROFILING_ENABLED build flag</name>
  <files>examples/lxmf_tdeck/platformio.ini</files>
  <action>
Add BOOT_PROFILING_ENABLED flag to both environments (tdeck and tdeck-bluedroid), following the same pattern as MEMORY_INSTRUMENTATION_ENABLED:

1. In [env:tdeck-bluedroid] build_flags section, add after MEMORY_INSTRUMENTATION_ENABLED:
```
    ; Enable boot profiling (timing instrumentation for setup phases)
    ; Remove this flag to disable boot profiling
    -DBOOT_PROFILING_ENABLED
```

2. In [env:tdeck] build_flags section, add after MEMORY_INSTRUMENTATION_ENABLED:
```
    ; Enable boot profiling (timing instrumentation for setup phases)
    ; Remove this flag to disable boot profiling
    -DBOOT_PROFILING_ENABLED
```

Keep consistent formatting with existing flags.
  </action>
  <verify>grep -c "BOOT_PROFILING_ENABLED" examples/lxmf_tdeck/platformio.ini returns 2</verify>
  <done>Build flag added to both T-Deck environments</done>
</task>

<task type="auto">
  <name>Task 2: Instrument setup() with boot profiling calls</name>
  <files>examples/lxmf_tdeck/src/main.cpp</files>
  <action>
Add BootProfiler instrumentation to main.cpp:

1. Add conditional include after memory instrumentation include (around line 64):
```cpp
// Boot profiling
#ifdef BOOT_PROFILING_ENABLED
#include <Instrumentation/BootProfiler.h>
#endif
```

2. In setup() function, instrument each phase. The current setup structure is:
   - Serial.begin + banner (lines 1017-1026)
   - setup_hardware (line 1029)
   - tone_init (line 1032)
   - load_app_settings (line 1035)
   - setup_gps (line 1038)
   - sync_time_from_gps (line 1041) - THIS IS A BLOCKING WAIT
   - setup_wifi (line 1049) - THIS CONTAINS BLOCKING WAITS
   - setup_lvgl_and_ui (line 1052)
   - setup_reticulum (line 1055)
   - setup_lxmf (line 1058) - CONTAINS 3-SECOND DELAY
   - setup_ui_manager (line 1061)
   - callback registration (lines 1064-1081)
   - final banner (lines 1083-1091)

Add profiling as follows (inside setup()):

After banner, before setup_hardware:
```cpp
#ifdef BOOT_PROFILING_ENABLED
    BOOT_PROFILE_START("serial_init");
    BOOT_PROFILE_END("serial_init");  // Banner already printed
#endif
```

Around setup_hardware():
```cpp
#ifdef BOOT_PROFILING_ENABLED
    BOOT_PROFILE_START("hardware");
#endif
    setup_hardware();
#ifdef BOOT_PROFILING_ENABLED
    BOOT_PROFILE_END("hardware");
#endif
```

Continue pattern for each function:
- tone_init -> "audio"
- load_app_settings -> "settings"
- setup_gps -> "gps"

For sync_time_from_gps (blocking wait):
```cpp
#ifdef BOOT_PROFILING_ENABLED
    BOOT_PROFILE_WAIT_START("gps_sync");
#endif
    if (app_settings.gps_time_sync) {
        // ... existing code
    }
#ifdef BOOT_PROFILING_ENABLED
    BOOT_PROFILE_WAIT_END("gps_sync");
#endif
```

Continue for:
- setup_wifi -> "wifi" (contains blocking WiFi.begin wait - mark as WAIT inside that function OR leave as single phase since we're timing the whole function)
- setup_lvgl_and_ui -> "lvgl"
- setup_reticulum -> "reticulum"
- setup_lxmf -> "lxmf" (contains 3s delay - mark as WAIT)
- setup_ui_manager -> "ui_manager"
- callback registration -> "callbacks"

After final banner:
```cpp
#ifdef BOOT_PROFILING_ENABLED
    BOOT_PROFILE_COMPLETE();
#endif
```

IMPORTANT: Since setup_wifi and setup_lxmf contain internal blocking waits that we want to track separately, we need to add WAIT markers inside those functions too:

In setup_wifi() around the WiFi.begin wait loop (lines 407-412):
```cpp
#ifdef BOOT_PROFILING_ENABLED
    BOOT_PROFILE_WAIT_START("wifi_connect");
#endif
    while (WiFi.status() != WL_CONNECTED && millis() - start < 30000) {
        delay(500);
        Serial.print(".");
    }
#ifdef BOOT_PROFILING_ENABLED
    BOOT_PROFILE_WAIT_END("wifi_connect");
#endif
```

In setup_lxmf() around the TCP stabilization delay (line 719):
```cpp
#ifdef BOOT_PROFILING_ENABLED
    BOOT_PROFILE_WAIT_START("tcp_stabilize");
#endif
    delay(3000);
#ifdef BOOT_PROFILING_ENABLED
    BOOT_PROFILE_WAIT_END("tcp_stabilize");
#endif
```
  </action>
  <verify>grep -c "BOOT_PROFILE_" examples/lxmf_tdeck/src/main.cpp shows profiling calls added</verify>
  <done>All setup phases instrumented with START/END and blocking waits marked with WAIT_START/WAIT_END</done>
</task>

</tasks>

<verification>
- Build flag present in both platformio.ini environments
- BootProfiler.h included conditionally in main.cpp
- Every setup_* function has START/END markers
- Blocking waits (GPS sync, WiFi connect, TCP stabilize) have WAIT_START/WAIT_END markers
- BOOT_PROFILE_COMPLETE() called at end of setup()
</verification>

<success_criteria>
- Boot sequence fully instrumented
- Clear distinction between init time and blocking wait time
- Build compiles with flag enabled (syntax correct)
- When run, serial output shows timing for each phase
</success_criteria>

<output>
After completion, create `.planning/phases/02-boot-profiling/02-02-SUMMARY.md`
</output>
