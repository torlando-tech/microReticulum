---
phase: 04-concurrency-audit
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/04-concurrency-audit/04-TASKS.md
autonomous: true

must_haves:
  truths:
    - "All FreeRTOS tasks are inventoried with stack sizes and yield patterns"
    - "Watchdog status (TWDT enabled/disabled) is documented"
    - "All blocking operations without timeout are identified"
    - "Task stack sizes are evaluated against HWM data from Phase 1"
  artifacts:
    - path: ".planning/phases/04-concurrency-audit/04-TASKS.md"
      provides: "FreeRTOS task and watchdog audit report"
      contains: "## Task Inventory"
  key_links:
    - from: "04-TASKS.md"
      to: "CONC-03 and CONC-05 requirements"
      via: "task analysis"
      pattern: "xTaskCreate|vTaskDelay|uxTaskGetStackHighWaterMark"
---

<objective>
Audit all FreeRTOS tasks for proper watchdog feeding, yield patterns, and stack size adequacy.

Purpose: Document all concurrent tasks in the system, verify they yield regularly to prevent starvation, and assess stack sizes against actual usage data from Phase 1 instrumentation.

Output: `.planning/phases/04-concurrency-audit/04-TASKS.md` with complete audit results.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-concurrency-audit/04-CONTEXT.md
@.planning/phases/04-concurrency-audit/04-RESEARCH.md
@.planning/phases/01-memory-instrumentation/01-VERIFICATION.md

Key files to audit:
- src/UI/LVGL/LVGLInit.cpp - LVGL task creation
- examples/common/ble_interface/BLEInterface.cpp - BLE task creation
- examples/lxmf_tdeck/src/main.cpp - Main loop and setup
- src/LXMF/LXStamper.cpp - CPU-intensive stamp generation
- src/BLE/platforms/BluedroidPlatform.cpp - Alternative BLE platform

Research findings:
- LVGL Task: 8KB stack, core 1, 5ms yield
- BLE Task: 8KB stack, core 0, 10ms yield
- Main loop: 5ms delay at end
- Task Watchdog Timer (TWDT) NOT currently enabled
- Phase 1 monitors HWM with 256-byte warning threshold
- Application-level watchdog patterns in Link.cpp/Resource.cpp (incomplete TODOs)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inventory all FreeRTOS tasks</name>
  <files>
    src/UI/LVGL/LVGLInit.cpp
    examples/common/ble_interface/BLEInterface.cpp
    examples/lxmf_tdeck/src/main.cpp
    src/LXMF/LXStamper.cpp
    src/BLE/platforms/BluedroidPlatform.cpp
    src/Instrumentation/MemoryMonitor.cpp
  </files>
  <action>
    1. Search for all xTaskCreate and xTaskCreatePinnedToCore calls
    2. For each task found, document:
       - Task name (as passed to xTaskCreate)
       - Stack size in bytes
       - Priority
       - Core affinity (if pinned)
       - File and line where created
       - Main loop function

    3. Document the main Arduino loop task:
       - Stack size (from platformio.ini or framework default)
       - What runs in it (reticulum.loop, interface.loop, etc.)

    4. Document timer-based tasks:
       - FreeRTOS software timers (xTimerCreate)
       - Memory monitor timer from Phase 1
       - Any other periodic callbacks

    Create table format:
    | Task | Stack | Priority | Core | Created At | Purpose |
  </action>
  <verify>All tasks in codebase found via grep for xTaskCreate patterns</verify>
  <done>Complete task inventory with stack sizes, priorities, and creation locations</done>
</task>

<task type="auto">
  <name>Task 2: Analyze yield patterns and blocking operations</name>
  <files>
    src/UI/LVGL/LVGLInit.cpp
    examples/common/ble_interface/BLEInterface.cpp
    examples/lxmf_tdeck/src/main.cpp
    src/LXMF/LXStamper.cpp
    src/Link.cpp
    src/Resource.cpp
    src/Transport.cpp
  </files>
  <action>
    1. For each task, find the yield mechanism:
       - vTaskDelay() calls with interval
       - delay() calls (Arduino wrapper)
       - taskYIELD() calls
       - xSemaphoreTake with timeout

    2. Identify all blocking operations:
       - portMAX_DELAY waits (indefinite)
       - Mutex acquisition without timeout
       - I/O operations that could stall
       - Network operations with long timeouts

    3. Document potential starvation scenarios:
       - Tasks that could block indefinitely
       - CPU-intensive operations without yield (crypto, etc.)
       - Busy-wait loops

    4. Check application-level watchdog patterns:
       - Link::start_watchdog() (TODO in code)
       - Resource watchdog_lock pattern
       - Any timeout mechanisms

    Create table format:
    | Task | Yield Method | Interval | Blocking Ops | Risk Level |
  </action>
  <verify>All yield patterns documented with blocking operation analysis</verify>
  <done>Yield pattern and blocking operation inventory complete</done>
</task>

<task type="auto">
  <name>Task 3: Assess stack sizes and watchdog status</name>
  <files>
    examples/lxmf_tdeck/platformio.ini
    src/Instrumentation/MemoryMonitor.cpp
    src/UI/LVGL/LVGLInit.cpp
    examples/common/ble_interface/BLEInterface.cpp
  </files>
  <action>
    1. Document ESP32 Task Watchdog Timer (TWDT) status:
       - Is CONFIG_ESP_TASK_WDT enabled in sdkconfig?
       - Are any tasks subscribed to TWDT?
       - What is the current watchdog timeout?
       - Recommend TWDT configuration if not enabled

    2. Stack size adequacy assessment:
       - Phase 1 MemoryMonitor uses 256-byte warning threshold
       - For each task, estimate typical stack usage:
         * LVGL: widget rendering depth
         * BLE: callback nesting with crypto
         * Main: Reticulum processing depth
       - Document risk level for each

    3. Cross-reference Phase 1 instrumentation:
       - uxTaskGetStackHighWaterMark monitoring
       - Warning thresholds
       - Any stack warnings observed (if data available)

    4. TWDT recommendation:
       - If not enabled: recommend enabling with 5-10s timeout
       - If enabled: verify all tasks are subscribed
       - Document which tasks should feed watchdog
  </action>
  <verify>Stack size and watchdog assessment complete</verify>
  <done>Stack adequacy evaluated with TWDT recommendation</done>
</task>

<task type="auto">
  <name>Task 4: Create 04-TASKS.md audit report</name>
  <files>.planning/phases/04-concurrency-audit/04-TASKS.md</files>
  <action>
    Create comprehensive audit report with sections:

    1. **Executive Summary** - Task count, watchdog status, issue count by severity
    2. **Task Inventory** - Table of all FreeRTOS tasks with:
       - Name, stack size, priority, core affinity
       - Creation location
       - Purpose
    3. **Yield Pattern Analysis** - Table with:
       - Task, yield method, interval, blocking operations
       - Risk assessment for each
    4. **Stack Size Assessment** - Table with:
       - Task, allocated size, estimated usage, margin
       - Phase 1 HWM monitoring cross-reference
       - Recommendations for size adjustments
    5. **Watchdog Status**
       - Current TWDT configuration
       - Recommendation for enabling/configuring
       - Which tasks should subscribe
    6. **Findings** - Each issue with:
       - Severity (Critical/High/Medium/Low)
       - Location
       - Description
       - Code snippet (3-5 lines)
       - Recommended fix
    7. **ASCII Diagram** - Task relationships showing:
       - Tasks on each core
       - Priority levels
       - Shared resources

    Include cross-reference to CONC-03 and CONC-05 requirements.
  </action>
  <verify>File exists with all required sections and ASCII diagram</verify>
  <done>04-TASKS.md contains complete task/watchdog audit</done>
</task>

</tasks>

<verification>
1. All FreeRTOS tasks inventoried (search for xTaskCreate confirms none missed)
2. Yield patterns documented for each task
3. Blocking operations identified with risk assessment
4. Stack sizes evaluated against usage estimates
5. TWDT status documented with recommendation
6. 04-TASKS.md exists with all required sections
</verification>

<success_criteria>
- 04-TASKS.md exists with Executive Summary, Task Inventory, Yield Analysis, Stack Assessment, Watchdog Status, Findings
- All tasks documented with stack/priority/core
- Yield patterns and blocking operations identified
- TWDT recommendation included
- CONC-03 and CONC-05 requirements addressed
</success_criteria>

<output>
After completion, create `.planning/phases/04-concurrency-audit/04-03-SUMMARY.md`
</output>
