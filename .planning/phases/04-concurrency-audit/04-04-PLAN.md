---
phase: 04-concurrency-audit
plan: 04
type: execute
wave: 2
depends_on:
  - 04-01
  - 04-02
  - 04-03
files_modified:
  - .planning/phases/04-concurrency-audit/04-MUTEX.md
  - .planning/phases/04-concurrency-audit/04-SUMMARY.md
autonomous: true

must_haves:
  truths:
    - "Mutex acquisition order is documented across all subsystems"
    - "Potential deadlock scenarios are identified with severity"
    - "Consolidated summary exists with all findings from 04-01 through 04-03"
    - "Priority fix recommendations are provided for Phase 5"
  artifacts:
    - path: ".planning/phases/04-concurrency-audit/04-MUTEX.md"
      provides: "Mutex ordering and deadlock analysis"
      contains: "## Recommended Acquisition Order"
    - path: ".planning/phases/04-concurrency-audit/04-SUMMARY.md"
      provides: "Consolidated phase 4 findings"
      contains: "## Issue Summary"
  key_links:
    - from: "04-SUMMARY.md"
      to: "04-LVGL.md, 04-NIMBLE.md, 04-TASKS.md, 04-MUTEX.md"
      via: "cross-references"
      pattern: "04-LVGL|04-NIMBLE|04-TASKS"
---

<objective>
Document mutex acquisition ordering for deadlock prevention and synthesize all Phase 4 findings into a consolidated summary.

Purpose: Complete the concurrency audit by analyzing mutex dependencies across all subsystems, documenting the recommended acquisition order, and consolidating all findings from prior plans into a prioritized summary for Phase 5.

Output: `.planning/phases/04-concurrency-audit/04-MUTEX.md` (mutex analysis) and `.planning/phases/04-concurrency-audit/04-SUMMARY.md` (consolidated findings).
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-concurrency-audit/04-CONTEXT.md
@.planning/phases/04-concurrency-audit/04-RESEARCH.md

Prior plan outputs (to synthesize):
@.planning/phases/04-concurrency-audit/04-LVGL.md
@.planning/phases/04-concurrency-audit/04-NIMBLE.md
@.planning/phases/04-concurrency-audit/04-TASKS.md

Key mutex locations from research:
- LVGLInit::_mutex (recursive semaphore) - LVGL API protection
- NimBLEPlatform::_conn_mutex (binary semaphore) - Connection map access
- NimBLEPlatform::_state_mux (spinlock) - State machine protection
- BLEInterface::_mutex (std::recursive_mutex) - Callback data protection

Recommended order (from research):
1. LVGL mutex (UI layer)
2. BLE interface mutex (network layer)
3. NimBLE connection mutex (platform layer)
4. State spinlocks (atomic operations only)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit mutex acquisition sites and build dependency graph</name>
  <files>
    src/UI/LVGL/LVGLInit.cpp
    src/UI/LVGL/LVGLLock.h
    src/UI/LXMF/UIManager.cpp
    src/BLE/platforms/NimBLEPlatform.cpp
    examples/common/ble_interface/BLEInterface.cpp
    src/Transport.cpp
    src/Link.cpp
  </files>
  <action>
    1. Find all mutex/semaphore definitions:
       - xSemaphoreCreateMutex / xSemaphoreCreateRecursiveMutex
       - xSemaphoreCreateBinary
       - portMUX_TYPE (spinlocks)
       - std::mutex / std::recursive_mutex

    2. For each mutex, document:
       - Type (recursive, binary, spinlock)
       - Purpose
       - Timeout used (portMAX_DELAY = indefinite)
       - Files that acquire it

    3. Build acquisition graph:
       - For each code path, trace mutex acquisitions
       - Identify any paths that acquire multiple mutexes
       - Document the order of acquisition

    4. Identify potential deadlock scenarios:
       - Cross-layer mutex acquisition (UI -> BLE or BLE -> UI)
       - Callback paths that might acquire mutexes
       - Nested acquisitions with different orders

    Severity for deadlock issues:
    - Critical = guaranteed deadlock under specific conditions
    - High = potential deadlock with race
    - Medium = unlikely but possible
  </action>
  <verify>All mutex sites found via grep patterns, acquisition graph documented</verify>
  <done>Complete mutex inventory with acquisition dependency graph</done>
</task>

<task type="auto">
  <name>Task 2: Create 04-MUTEX.md with ordering analysis</name>
  <files>.planning/phases/04-concurrency-audit/04-MUTEX.md</files>
  <action>
    Create mutex analysis report with sections:

    1. **Executive Summary** - Mutex count, deadlock risk assessment
    2. **Mutex Inventory** - Table with:
       - Name, type, location, purpose, timeout
    3. **Acquisition Analysis**
       - For each major code path, trace mutex acquisitions
       - Document any multi-mutex paths
    4. **Deadlock Potential Assessment**
       - Identified scenarios with severity
       - Cross-subsystem concerns (LVGL <-> BLE)
       - Callback-to-UI update patterns
    5. **Recommended Acquisition Order**
       ```
       1. LVGL mutex (UI layer - outermost)
       2. BLE interface mutex (network layer)
       3. NimBLE connection mutex (platform layer)
       4. State spinlocks (innermost - atomic only)
       ```
       - Rationale for this order
       - How to enforce in code
    6. **ASCII Diagram** - Mutex dependency graph showing:
       - Layers (UI -> Network -> Platform)
       - Which components acquire which mutexes
       - Safe vs dangerous acquisition paths

    Include cross-reference to CONC-04 requirement.
  </action>
  <verify>File exists with mutex inventory, acquisition analysis, and recommended order</verify>
  <done>04-MUTEX.md contains complete mutex ordering analysis with deadlock prevention guidance</done>
</task>

<task type="auto">
  <name>Task 3: Create 04-SUMMARY.md consolidating all findings</name>
  <files>
    .planning/phases/04-concurrency-audit/04-SUMMARY.md
    .planning/phases/04-concurrency-audit/04-LVGL.md
    .planning/phases/04-concurrency-audit/04-NIMBLE.md
    .planning/phases/04-concurrency-audit/04-TASKS.md
    .planning/phases/04-concurrency-audit/04-MUTEX.md
  </files>
  <action>
    Create consolidated summary with sections:

    1. **Executive Summary**
       - Phase 4 scope: concurrency audit across LVGL, NimBLE, FreeRTOS tasks
       - Total findings by severity (Critical/High/Medium/Low)
       - Key risks identified

    2. **Issue Summary Table**
       | ID | Severity | Subsystem | Issue | Source Doc |
       Each issue from 04-LVGL.md, 04-NIMBLE.md, 04-TASKS.md, 04-MUTEX.md

    3. **Severity Breakdown**
       - Critical issues (if any): immediate crash/corruption risk
       - High issues: deadlock, leak, starvation risks
       - Medium issues: race conditions, degraded behavior
       - Low issues: code smells, documentation gaps

    4. **Cross-Subsystem Concerns**
       - LVGL <-> BLE interaction patterns
       - Callback threading (NimBLE -> deferred -> LVGL)
       - Mutex ordering across layers

    5. **Phase 5 Backlog Items** (from concurrency findings)
       - Priority 1 (Critical): Items requiring immediate fix
       - Priority 2 (High): Should fix before production
       - Priority 3 (Medium): Fix when convenient
       - Priority 4 (Low): Document/defer

    6. **Recommendations**
       - Enable TWDT if not already
       - Enforce mutex ordering via documentation/review
       - Consider mutex timeout instead of portMAX_DELAY
       - Document threading assumptions in code

    7. **Architecture Diagram**
       ASCII showing all tasks, mutexes, and interactions

    Cross-reference CONC-01 through CONC-05 requirements.
  </action>
  <verify>File exists with consolidated findings from all subsystem audits</verify>
  <done>04-SUMMARY.md contains complete Phase 4 synthesis with priority backlog</done>
</task>

</tasks>

<verification>
1. All mutex definitions found and documented
2. Acquisition order analyzed with deadlock scenarios
3. 04-MUTEX.md exists with recommended ordering
4. 04-SUMMARY.md consolidates all findings from 04-01 through 04-04
5. Priority backlog for Phase 5 is included
6. All CONC-01 through CONC-05 requirements addressed
</verification>

<success_criteria>
- 04-MUTEX.md exists with Mutex Inventory, Acquisition Analysis, Recommended Order, and ASCII diagram
- 04-SUMMARY.md exists with Issue Summary Table, Severity Breakdown, Phase 5 Backlog
- All findings from prior plans consolidated
- Cross-subsystem concerns documented
- CONC-04 requirement addressed
</success_criteria>

<output>
After completion, create `.planning/phases/04-concurrency-audit/04-04-SUMMARY.md`
</output>
