# Milestone v1.1: Stability Quick Wins

**Status:** ✅ SHIPPED 2026-01-24
**Phases:** 6
**Total Plans:** 2

## Overview

Fix the 5 highest-priority stability issues identified in v1 audit (P1 items with WSJF ≥ 3.0) to establish firmware stability baseline for extended operation.

## Phases

### Phase 6: P1 Stability Fixes

**Goal**: Eliminate critical memory and concurrency issues preventing reliable extended operation
**Depends on**: Phase 5 (backlog created)
**Requirements**: MEM-01, MEM-02, CONC-01, CONC-02, CONC-03
**Plans**: 2 plans

**Success Criteria:**
1. Firmware compiles cleanly with no ODR violations or linker warnings
2. Large file transfers complete without heap fragmentation from vector reallocations
3. Task starvation and deadlocks are detected by watchdog timer
4. UI remains responsive during stamp generation operations
5. Concurrent BLE operations execute without race conditions or crashes

Plans:
- [x] 06-01: Fix memory issues (ODR violation in Persistence, pre-allocate ResourceData vectors)
- [x] 06-02: Fix concurrency issues (TWDT enablement, LXStamper yield, BLE mutex protection)

**Details:**

Files modified:
- `src/Utilities/Persistence.h` - extern declarations for JsonDocument
- `src/Utilities/Persistence.cpp` - Single definitions in namespace scope
- `src/ResourceData.h` - MAX_PARTS constant, vector pre-allocation
- `examples/lxmf_tdeck/sdkconfig.defaults` - TWDT configuration
- `src/UI/LVGL/LVGLInit.cpp` - TWDT subscription and reset
- `src/LXMF/LXStamper.cpp` - Yield frequency improvement, watchdog reset
- `examples/common/ble_interface/BLEInterface.cpp` - Mutex protection

---

## Milestone Summary

**Key Decisions:**
- Use ArduinoJson 7 JsonDocument (elastic allocation) instead of deprecated DynamicJsonDocument
- MAX_PARTS = 256 based on MAX_EFFICIENT_SIZE (16384) / minimum SDU (~64)
- 10 second TWDT timeout balances detection speed vs margin for crypto operations
- Yield every 10 rounds (not 100) for 10x better UI responsiveness during stamping
- Use existing recursive_mutex for BLE callback protection (RAII pattern)

**Issues Resolved:**
- MEM-M4: Duplicate static definition in Persistence causing ODR violation
- MEM-H5: ResourceData vectors growing during large file transfers
- CONC-H1: TWDT not configured, task starvation undetected
- CONC-H2: LXStamper CPU hogging during stamp generation
- CONC-H3: BLE pending queues accessed without mutex protection

**Issues Deferred:**
- P2 issues (WSJF 2.0): ArduinoJson 7 full migration, LVGL_LOCK in screen constructors
- P3 issues (WSJF 0.8-1.4): Pool allocators, deeper allocation refactoring
- Boot time <5s: Currently at 5.3s, code changes needed for further reduction

**Technical Debt Incurred:**
- Pre-existing TODOs in Persistence.h (lines 294, 395, 597, 640) remain unaddressed
- Native build environment has pre-existing MsgPack failures (unrelated to milestone)

---

_For current project status, see .planning/ROADMAP.md_
